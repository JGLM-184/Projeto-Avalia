<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Questões</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<link rel="icon" type="image/png" href="/imagens/logo.png">
</head>

<body class="coordinator-layout">
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<!-- Conteúdo Principal da tela -->
<main class="main-content">
    <div class="bank-container">
    
	<!-- FORMULÁRIO DE EDIÇÃO -->
	    <form th:if="${isEdicaoQuestao == true}" th:action="@{'/questao/gerenciar/atualizar/' + ${questaoDTO.id}}" method="post" enctype="multipart/form-data" th:object="${questaoDTO}">
	        <div class="card p-4 shadow-sm">
	            
			<!-- Tag de usuário -->
			<div class="mb-3">
			    <label class="form-label">Autor</label>

			    <!-- Campo visível (apenas leitura) -->
			    <input type="text" class="form-autor" 
			           th:value="${questaoDTO.autor.nome}" 
			           disabled>

			    <!-- Campo oculto para enviar o ID do autor no POST -->
			    <input type="hidden" th:field="*{autor.id}">
			</div>
				
	            <div class="row">
					<div class="col-md-4 mb-3">
					    <label class="form-label">Curso</label>
					    <select id="cursoSelect" class="form-select" th:field="*{curso.id}" required>
					        <option value="0" disabled selected>Selecione...</option>
					        <option th:each="curso : ${autorLogado.cursos}"
					                th:value="${curso.id}"
					                th:text="${curso.nome}"></option>
					    </select>
					</div>
				
					<div class="col-md-4 mb-3">
					    <label class="form-label">Disciplina</label>
						<select id="disciplinaSelect" class="form-select" th:field="*{disciplina.id}" data-selected="${questaoDTO.disciplina.id}">
						    <option value="0" disabled>Selecione...</option>
						</select>
					</div>
	            </div>

	            <div class="form-check mb-3">
					<input class="form-check-input" type="checkbox" th:field="*{simulado}" id="simuladoEdicao">
					<label for="simuladoEdicao">Questão de Simulado</label>
	            </div>
				
				<div class="mb-3">
	                <label class="form-label">Enunciado</label>
	                <textarea class="form-control quebraTexto" th:field="*{enunciado}" rows="3" required></textarea>
	            </div>

				<div class="mb-3">
				    <label class="form-label">Imagem (opcional)</label>

					<div class="image-placeholder-edicao">

					    <!-- Input invisível -->
					    <input type="file" class="image-input" name="file"
					           style="display:none;" accept="image/*">

					    <!-- Se tem imagem -->
					    <img class="image-preview"
					         th:if="${questaoDTO.imagem != null and questaoDTO.imagem != ''}"
					         th:src="${questaoDTO.imagem}"
					         alt="Imagem da Questão"
					         style="max-width:100%; max-height:100%;">

					    <!-- Botão remover imagem -->
					    <button type="button"
					            th:if="${questaoDTO.imagem != null and questaoDTO.imagem != ''}"
					            id="btnRemoverImagem"
					            class="btn btn-remover btn-sm"
					            style="position:absolute; top:5px; right:5px;">
					        Remover
					    </button>

					    <!-- Se NÃO tem imagem -->
					    <div class="image-content"
					         th:if="${questaoDTO.imagem == null or questaoDTO.imagem == ''}"
					         style="text-align:center; color:#666;">
					        <span class="material-icons" style="font-size:40px;">add</span>
					        <p>Adicionar imagem</p>
					    </div>
					</div>

				    <!-- Campo oculto indicando remoção -->
				    <input type="hidden" name="removerImagem" id="removerImagemInput" value="false">
				</div>
				
				<div class="mb-3">
				    <label class="form-label">Quantidade de Alternativas</label>
				    <select id="quantidadeAlternativasEditar" class="form-check-label">
				        <option value="2" th:selected="${qntAlternativas == 2}">2</option>
				        <option value="4" th:selected="${qntAlternativas == 4}">4</option>
				        <option value="5" th:selected="${qntAlternativas == 5}">5</option>
				    </select>
				</div>
				
				<h5>Alternativas</h5>
				<div id="alternativasContainerEditar">
				    <!-- Render inicial das alternativas vindas do servidor -->
				    <div th:each="alt, iterStat : *{alternativas}" class="mb-3 alternativa-item">
						<div class="input-group" style="display: flex; align-items: center; gap: 10px;">
						    <input type="radio"
						           name="alternativaCorretaIndex"
						           th:value="${iterStat.index}"
						           th:checked="${alt.correto}" required>

						    <span>
						        [[${T(java.lang.Character).toString(65 + iterStat.index)}]])
						    </span>

						    <input type="text"
						           class="alternative-item"
						           th:field="*{alternativas[__${iterStat.index}__].texto}"
						           placeholder="Digite o texto da alternativa..." />
						</div>
				    </div>
				</div>

	            <div class="text-end mt-4">
	                <button type="submit" class="btn btn-normal">Atualizar Questão</button>
	                <a th:href="@{/questao/banco}" class="btn btn-secondary">Cancelar</a>
	            </div>
	        </div>
	    </form>
            
        </div>
    </div>
</main>

<!-- Script para a quantidade de alternativas variarem no formulário de edição -->
<script>
    const containerEditar = document.getElementById("alternativasContainerEditar");
    const selectEditar = document.getElementById("quantidadeAlternativasEditar");

    function gerarAlternativasEditar(qtd) {
        const valoresExistentes = Array.from(containerEditar.querySelectorAll('input[type="text"]'))
            .map(input => input.value);

        const indexCorreta = containerEditar.querySelector('input[type="radio"]:checked')?.value;

        containerEditar.innerHTML = "";

        for (let i = 0; i < qtd; i++) {
            const div = document.createElement("div");
            div.classList.add("mb-3", "alternativa-item");

            const letra = String.fromCharCode(65 + i); // A, B, C...

            const textoExistente = valoresExistentes[i] || "";
            const checked = indexCorreta == i ? "checked" : "";

            div.innerHTML = `
                <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="alternativaCorretaIndex" value="${i}" ${checked} required>
                    <span>${letra})</span>
                    <input type="text" class="alternative-item"
                        name="alternativas[${i}].texto"
                        value="${textoExistente}"
                        placeholder="Digite o texto da alternativa..."
                        required>
                </div>
            `;
            containerEditar.appendChild(div);
        }
    }

    selectEditar.addEventListener("change", function() {
        gerarAlternativasEditar(this.value);
    });
</script>


<!--  Script para as disciplinas mudarem de acordo com o curso selecionado -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const cursoSelect = document.getElementById("cursoSelect");
    const disciplinaSelect = document.getElementById("disciplinaSelect");

    // Função que carrega disciplinas
    function carregarDisciplinas(cursoId, disciplinaSelecionada) {
        if (!cursoId) return;

        fetch(`/questao/disciplinas/api/por-curso/${cursoId}`)
            .then(response => {
                if (!response.ok) throw new Error("Erro ao buscar disciplinas");
                return response.json();
            })
            .then(disciplinas => {
                disciplinaSelect.innerHTML = '<option value="0" disabled>Selecione...</option>';

                disciplinas.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id;
                    option.textContent = d.nome;

                    // Seleciona automaticamente a disciplina da questão
                    if (disciplinaSelecionada && Number(disciplinaSelecionada) === d.id) {
                        option.selected = true;
                    }

                    disciplinaSelect.appendChild(option);
                });
            })
            .catch(err => {
                console.error(err);
                disciplinaSelect.innerHTML =
                    '<option value="0" disabled selected>Erro ao carregar disciplinas</option>';
            });
    }

    // Carrega disciplinas automaticamente ao abrir a tela
    const cursoInicial = cursoSelect.value;
    const disciplinaInicial = disciplinaSelect.dataset.selected;

    if (cursoInicial && cursoInicial !== "0") {
        carregarDisciplinas(cursoInicial, disciplinaInicial);
    }

    // Carrega disciplinas ao trocar o curso
    cursoSelect.addEventListener("change", function() {
        carregarDisciplinas(this.value, null);
    });

});
</script>


<!-- Script para mostrar imagem dentro da area -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const placeholder = document.querySelector('.image-placeholder-edicao');
    const input = placeholder.querySelector('.image-input');
    const content = placeholder.querySelector('.image-content');
    const preview = placeholder.querySelector('.image-preview');

    // Tornar toda a área clicável
    placeholder.addEventListener("click", () => input.click());

    // Atualizar visual quando escolher nova imagem
    input.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {

            if (preview) {
                preview.src = e.target.result;
            } else {
                // Criar a imagem se ainda não existir
                const img = document.createElement("img");
                img.classList.add("image-preview");
                img.style.maxWidth = "100%";
                img.style.maxHeight = "100%";
                img.src = e.target.result;
                placeholder.appendChild(img);
            }

            if (content) content.style.display = 'none';
        };
        reader.readAsDataURL(file);
    });

});
</script>

<!-- Script para remover imagem -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const btnRemover = document.getElementById("btnRemoverImagem");
    const removerInput = document.getElementById("removerImagemInput");
    const placeholder = document.querySelector(".image-placeholder-edicao");
    const preview = document.querySelector(".image-preview");

    if (btnRemover) {
        btnRemover.addEventListener("click", function(event) {
            event.stopPropagation(); // evitar abrir seleção de arquivo

            // Marca que deve remover no backend
            removerInput.value = "true";

            // Some com a imagem
            if (preview) preview.remove();

            // Some com o botão
            btnRemover.remove();

            // Volta o bloco "Adicionar imagem"
            const content = document.createElement("div");
            content.classList.add("image-content");
            content.style.textAlign = "center";
            content.style.color = "#666";
            content.innerHTML = `
                <span class="material-icons" style="font-size:40px;">add</span>
                <p>Adicionar imagem</p>
            `;
            placeholder.appendChild(content);
        });
    }

});
</script>

</body>
</html>