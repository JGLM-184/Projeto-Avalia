<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Montar Prova</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="coordinator-layout">

<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>
	
<main class="main-content">
    <div class="exam-assembly-container">
        <!-- Painel Esquerdo -->
        <div class="left-panel">
            <div class="card">
                <h4 style="margin-bottom: 24px; color: var(--text-dark);">Configurações da Prova</h4>
                
                <!-- Formulário de Configuração da Prova -->
                <div class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">Título da Prova</label>
                        <input type="text" class="form-control" id="tituloProva" 
                               th:value="${tituloProvaAtual}"
                               placeholder="Digite o título da prova">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Curso</label>
                        <select class="form-select" id="cursoId">
                            <option value="">Selecione um curso...</option>
                            <option th:each="curso : ${cursos}"
                                    th:value="${curso.id}"
                                    th:text="${curso.nome}"
                                    th:selected="${cursoIdAtual != null && cursoIdAtual == curso.id}"></option>
                        </select>
                    </div>
                    
                    <div class="custom-checkbox mb-3">
                        <input type="checkbox" id="simulado" th:checked="${simuladoAtual}">
                        <label for="simulado">Prova de Simulado</label>
                    </div>
                </div>
                
                <!-- Seção Disciplina -->
                <div class="discipline-section">
                    <label class="discipline-label">Filtrar questões por disciplina</label>
					<div class="dropdown">
						<form th:action="@{/provas/montar}" method="get" id="filtroDisciplina">
                            <select class="form-select" name="disciplinaId" id="selectDisciplina" onchange="submeterFiltroDisciplina()">
                                <option value="0">Todas as disciplinas</option>
                                <option th:each="disciplina : ${disciplinas}"
                                        th:value="${disciplina.id}"
                                        th:text="${disciplina.nome}"
                                        th:selected="${disciplinaIdAtual != null && disciplinaIdAtual == disciplina.id}"></option>
                            </select>
                            <input type="hidden" name="pesquisa" id="hiddenPesquisa">
                            <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        </form>
				    </div>
                    
                    <div class="quantity-section">
                        <label class="discipline-label">Quantidade de questões por matéria</label>
                        <div class="quantity-input-container">
                            <input type="number" class="form-input quantity-input" value="4" min="1" max="50">   
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação FUNCIONAIS -->
                <div class="action-buttons-grid">
					<form th:action="@{/provas/montar}" method="get" class="d-inline w-100">
                        <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdAleatorias">
                        <input type="hidden" name="pesquisa" id="hiddenPesquisaAleatorias">
                        <input type="hidden" name="acao" value="aleatorias">
                        <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        <button type="submit" class="btn action-btn random-btn w-100" onclick="prepararFormAleatorias()">
                            <span class="material-icons">shuffle</span>
                            Escolher Questões Aleatoriamente
                        </button>
                    </form>

                    <form th:action="@{/provas/montar}" method="get" class="d-inline w-100">
                        <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdEmbaralhar">
                        <input type="hidden" name="pesquisa" id="hiddenPesquisaEmbaralhar">
                        <input type="hidden" name="acao" value="embaralhar">
                        <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        <button type="submit" class="btn action-btn w-100" onclick="prepararFormEmbaralhar()">
                            <span class="material-icons">shuffle</span>
                            Embaralhar Questões
                        </button>
                    </form>

                    <a th:href="@{/provas/editar-cabecalho}" class="btn action-btn w-100" onclick="salvarEstadoAntesDeSair()">
                        <span class="material-icons">description</span>
                        Editar Cabeçalho
                    </a>

                    <form th:action="@{/provas/montar}" method="get" class="d-inline w-100">
                        <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdAlternativas">
                        <input type="hidden" name="pesquisa" id="hiddenPesquisaAlternativas">
                        <input type="hidden" name="acao" value="embaralharAlternativas">
                        <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        <button type="submit" class="btn action-btn w-100" onclick="prepararFormAlternativas()">
                            <span class="material-icons">shuffle</span>
                            Embaralhar Alternativas
                        </button>
                    </form>

                    <!-- Botão Ver Prévia CORRIGIDO -->
                    <form th:action="@{/provas/previa}" method="get" class="d-inline w-100" id="formPrevia">
                        <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        <button type="submit" class="btn action-btn w-100" onclick="prepararFormPrevia()">
                            <span class="material-icons">visibility</span>
                            Ver Prévia
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Painel Direito -->
        <div class="right-panel">
            <div class="card">
                <h4 style="margin-bottom: 24px; color: var(--text-dark);">
                    Lista de Questões
                    <span th:if="${disciplinaSelecionada != null}" class="badge bg-primary ms-2" th:text="${disciplinaSelecionada.nome}"></span>
                    <span th:if="${disciplinaSelecionada == null}" class="badge bg-secondary ms-2">Todas as disciplinas</span>
                    <span th:if="${termoPesquisa != null}" class="badge bg-info ms-2" th:text="'Pesquisa: ' + ${termoPesquisa}"></span>
                    <span th:if="${questoesSelecionadas != null && !questoesSelecionadas.empty}" class="badge bg-success ms-2" th:text="'Selecionadas: ' + ${questoesSelecionadas.size()}"></span>
                </h4>
                
                <!-- Mensagens de feedback -->
                <div th:if="${mensagem != null}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${mensagem}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${erro != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${erro}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <!-- Barra de Pesquisa FUNCIONAL -->
                <div class="search-input-container">
                    <form th:action="@{/provas/montar}" method="get" class="d-flex w-100" id="formPesquisa">
                        <span class="material-icons search-icon">search</span>
                        <input type="text" 
                               class="form-input" 
                               name="pesquisa" 
                               id="inputPesquisa"
                               th:value="${pesquisaAtual}"
                               placeholder="Pesquisar questão por enunciado, disciplina, curso ou autor..."
                               style="border: none; outline: none; flex: 1;">
                        <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdPesquisa">
                        <!-- As questões selecionadas serão adicionadas dinamicamente -->
                        <button type="submit" class="btn btn-link p-0" style="border: none; background: none;" onclick="prepararFormPesquisa()">
                            <span class="material-icons" style="color: #666;">search</span>
                        </button>
                        <button type="button" class="clear-button" onclick="limparPesquisa()">
                            <span class="material-icons">close</span>
                        </button>
                    </form>
                </div>

                <!-- Lista de Questões COM SELEÇÃO PERSISTENTE -->
                <div class="questions-list">
                    <div th:if="${questoes != null && !questoes.empty}">
                        <form th:action="@{/provas/montar}" method="get" id="formSelecao">
                            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdSelecao">
                            <input type="hidden" name="pesquisa" id="hiddenPesquisaSelecao">
                            
                            <div class="question-item" th:each="questao : ${questoes}">
                                <div class="question-content">
                                    <div class="question-meta">
                                        <span class="discipline-badge" th:text="${questao.disciplina.nome}"></span>
                                        <small class="text-muted ms-2" th:text="${questao.curso.nome}"></small>
                                        <span th:if="${questoesSelecionadas.contains(questao.id)}" class="badge bg-success ms-2">Selecionada</span>
                                    </div>
                                    <p class="question-text" th:text="${questao.enunciado}"></p>
                                    <div th:if="${questao.imagem != null}" class="question-image">
                                        <span class="material-icons">image</span>
                                        <small class="text-muted">Contém imagem</small>
                                    </div>
                                    <div class="question-info">
                                        <small class="text-muted">
                                            <strong>Autor:</strong> <span th:text="${questao.autor.nome}"></span> |
                                            <strong>Tipo:</strong> <span th:if="${questao.simulado}">Simulado</span><span th:unless="${questao.simulado}">Regular</span>
                                        </small>
                                    </div>
                                </div>
                                <label class="checkbox-container">
                                    <input type="checkbox" 
                                           th:value="${questao.id}" 
                                           name="questoesSelecionadas"
                                           th:checked="${questoesSelecionadas.contains(questao.id)}"
                                           onchange="atualizarSelecao()">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </form>
                    </div>
                    
                    <div th:if="${questoes == null || questoes.empty}" class="text-center py-4">
                        <span class="material-icons text-muted" style="font-size: 48px;">help_outline</span>
                        <p class="text-muted mt-2" th:if="${disciplinaSelecionada == null && termoPesquisa == null}">Selecione uma disciplina para ver as questões</p>
                        <p class="text-muted mt-2" th:if="${disciplinaSelecionada != null && termoPesquisa == null}">Nenhuma questão encontrada para esta disciplina</p>
                        <p class="text-muted mt-2" th:if="${termoPesquisa != null}">Nenhuma questão encontrada para a pesquisa: "<span th:text="${termoPesquisa}"></span>"</p>
                        <button th:if="${termoPesquisa != null}" class="btn btn-sm btn-outline-secondary mt-2" onclick="limparPesquisa()">
                            Limpar Pesquisa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Barra de Ações Inferior FUNCIONAL -->
    <div class="footer-actions">
        <form th:action="@{/provas/montar}" method="get" class="d-inline">
            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdSalvar">
            <input type="hidden" name="pesquisa" id="hiddenPesquisaSalvar">
            <input type="hidden" name="tituloProva" id="hiddenTituloProvaSalvar">
            <input type="hidden" name="cursoId" id="hiddenCursoIdSalvar">
            <input type="hidden" name="simulado" id="hiddenSimuladoSalvar">
            <input type="hidden" name="acao" value="salvar">
            <!-- As questões selecionadas serão adicionadas dinamicamente -->
            <button type="submit" class="btn btn-primary" onclick="prepararFormSalvar()">
                <span class="material-icons">save</span>
                Salvar Prova
            </button>
        </form>

        <form th:action="@{/provas/montar}" method="get" class="d-inline">
            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdPdf">
            <input type="hidden" name="pesquisa" id="hiddenPesquisaPdf">
            <input type="hidden" name="tituloProva" id="hiddenTituloProvaPdf">
            <input type="hidden" name="cursoId" id="hiddenCursoIdPdf">
            <input type="hidden" name="simulado" id="hiddenSimuladoPdf">
            <input type="hidden" name="acao" value="pdf">
            <!-- As questões selecionadas serão adicionadas dinamicamente -->
            <button type="submit" class="btn btn-secondary" onclick="prepararFormPdf()">
                <span class="material-icons">picture_as_pdf</span>
                Gerar PDF
            </button>
        </form>
    </div>
</main>

<script>
// Sistema de persistência de estado
let estadoMontarProva = {
    tituloProva: '',
    cursoId: '',
    simulado: false,
    disciplinaId: '0',
    pesquisa: '',
    questoesSelecionadas: [],
    ordemQuestoes: []
};

// Verificar se deve limpar campos (após salvar com sucesso)
const limparCampos = /*[[${limparCampos}]]*/ false;

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando montarProva...');
    console.log('Limpar campos:', limparCampos);
    
    if (limparCampos) {
        console.log('Limpando campos após salvar prova...');
        limparTodosOsCampos();
    } else {
        carregarEstado();
    }
    
    configurarEventListeners();
});

function limparTodosOsCampos() {
    console.log('=== LIMPANDO TODOS OS CAMPOS ===');
    
    // Limpar campos do formulário
    document.getElementById('tituloProva').value = '';
    document.getElementById('cursoId').value = '';
    document.getElementById('simulado').checked = false;
    document.getElementById('selectDisciplina').value = '0';
    document.getElementById('inputPesquisa').value = '';
    
    // Desmarcar todas as checkboxes de questões
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Limpar localStorage
    localStorage.removeItem('estadoMontarProva');
    localStorage.removeItem('cabecalhoProva');
    
    // Resetar estado
    estadoMontarProva = {
        tituloProva: '',
        cursoId: '',
        simulado: false,
        disciplinaId: '0',
        pesquisa: '',
        questoesSelecionadas: [],
        ordemQuestoes: []
    };
    
    console.log('Todos os campos foram limpos!');
    
    // Mostrar mensagem de sucesso
    setTimeout(() => {
        alert('Prova salva com sucesso! Campos limpos para nova prova.');
    }, 100);
}

function carregarEstado() {
    const estadoSalvo = localStorage.getItem('estadoMontarProva');
    if (estadoSalvo) {
        estadoMontarProva = JSON.parse(estadoSalvo);
        console.log('Estado carregado:', estadoMontarProva);
        
        // Aplicar estado aos campos
        document.getElementById('tituloProva').value = estadoMontarProva.tituloProva || '';
        document.getElementById('cursoId').value = estadoMontarProva.cursoId || '';
        document.getElementById('simulado').checked = estadoMontarProva.simulado || false;
        document.getElementById('selectDisciplina').value = estadoMontarProva.disciplinaId || '0';
        document.getElementById('inputPesquisa').value = estadoMontarProva.pesquisa || '';
        
        // Marcar checkboxes das questões selecionadas
        if (estadoMontarProva.questoesSelecionadas && estadoMontarProva.questoesSelecionadas.length > 0) {
            const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]');
            checkboxes.forEach(checkbox => {
                const questaoId = parseInt(checkbox.value);
                checkbox.checked = estadoMontarProva.questoesSelecionadas.includes(questaoId);
            });
        }
    }
}

function salvarEstado() {
    // Coletar dados atuais
    estadoMontarProva.tituloProva = document.getElementById('tituloProva').value;
    estadoMontarProva.cursoId = document.getElementById('cursoId').value;
    estadoMontarProva.simulado = document.getElementById('simulado').checked;
    estadoMontarProva.disciplinaId = document.getElementById('selectDisciplina').value;
    estadoMontarProva.pesquisa = document.getElementById('inputPesquisa').value;
    
    // Coletar questões selecionadas
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]:checked');
    estadoMontarProva.questoesSelecionadas = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // Salvar no localStorage
    localStorage.setItem('estadoMontarProva', JSON.stringify(estadoMontarProva));
    console.log('Estado salvo:', estadoMontarProva);
}

function configurarEventListeners() {
    // Salvar estado quando campos mudarem
    const elementos = [
        'tituloProva', 'cursoId', 'simulado', 'selectDisciplina', 'inputPesquisa'
    ];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.addEventListener('change', salvarEstado);
            elemento.addEventListener('input', salvarEstado);
        }
    });
    
    // Salvar estado quando checkboxes mudarem
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', salvarEstado);
    });
    
    // Salvar estado antes de sair da página
    window.addEventListener('beforeunload', salvarEstado);
}

function salvarEstadoAntesDeSair() {
    salvarEstado();
}

// FUNÇÃO PRINCIPAL CORRIGIDA: Preparar formulário com múltiplas questões
function prepararFormularioComMultiplasQuestoes(acao) {
    console.log('Preparando formulário para:', acao);
    
    const disciplinaId = document.getElementById('selectDisciplina').value;
    const pesquisa = document.getElementById('inputPesquisa').value;
    
    // Coletar questões selecionadas
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]:checked');
    const questaoIds = Array.from(checkboxes).map(cb => cb.value);
    
    console.log('Questões selecionadas para', acao + ':', questaoIds);
    
    // Encontrar o formulário correto
    let form;
    if (acao === 'previa') {
        form = document.getElementById('formPrevia');
    } else {
        form = document.querySelector(`form input[name="acao"][value="${acao}"]`).closest('form');
    }
    
    if (!form) {
        console.error('Formulário não encontrado para ação:', acao);
        return;
    }
    
    // Limpar inputs antigos de questões
    const inputsAntigos = form.querySelectorAll('input[name="questoesSelecionadas"]');
    inputsAntigos.forEach(input => input.remove());
    
    // Adicionar cada questão como um input separado
    questaoIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'questoesSelecionadas';
        input.value = id;
        form.appendChild(input);
    });
    
    // Atualizar outros campos
    const disciplinaInput = form.querySelector('input[name="disciplinaId"]');
    const pesquisaInput = form.querySelector('input[name="pesquisa"]');
    
    if (disciplinaInput) disciplinaInput.value = disciplinaId;
    if (pesquisaInput) pesquisaInput.value = pesquisa;
    
    // Adicionar configurações da prova para os formulários de salvar e PDF
    if (acao === 'salvar' || acao === 'pdf') {
        const tituloInput = form.querySelector('input[name="tituloProva"]');
        const cursoInput = form.querySelector('input[name="cursoId"]');
        const simuladoInput = form.querySelector('input[name="simulado"]');
        
        if (tituloInput) tituloInput.value = document.getElementById('tituloProva').value;
        if (cursoInput) cursoInput.value = document.getElementById('cursoId').value;
        if (simuladoInput) simuladoInput.value = document.getElementById('simulado').checked;
    }
    
    salvarEstado();
    console.log(`Formulário ${acao} preparado com ${questaoIds.length} questões`);
}

// Funções específicas para cada ação
function prepararFormPrevia() {
    prepararFormularioComMultiplasQuestoes('previa');
}

function prepararFormAleatorias() {
    prepararFormularioComMultiplasQuestoes('aleatorias');
}

function prepararFormEmbaralhar() {
    prepararFormularioComMultiplasQuestoes('embaralhar');
}

function prepararFormAlternativas() {
    prepararFormularioComMultiplasQuestoes('embaralharAlternativas');
}

function prepararFormSalvar() {
    prepararFormularioComMultiplasQuestoes('salvar');
}

function prepararFormPdf() {
    prepararFormularioComMultiplasQuestoes('pdf');
}

// Função para preparar pesquisa
function prepararFormPesquisa() {
    const form = document.getElementById('formPesquisa');
    
    // Limpar inputs antigos de questões
    const inputsAntigos = form.querySelectorAll('input[name="questoesSelecionadas"]');
    inputsAntigos.forEach(input => input.remove());
    
    // Coletar questões selecionadas
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]:checked');
    const questaoIds = Array.from(checkboxes).map(cb => cb.value);
    
    // Adicionar cada questão como um input separado
    questaoIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'questoesSelecionadas';
        input.value = id;
        form.appendChild(input);
    });
    
    // Atualizar disciplina
    document.getElementById('hiddenDisciplinaIdPesquisa').value = document.getElementById('selectDisciplina').value;
    
    salvarEstado();
}

// Função para atualizar seleção de questões
function atualizarSelecao() {
    salvarEstado();
    
    // Preparar e submeter o formulário
    document.getElementById('hiddenDisciplinaIdSelecao').value = document.getElementById('selectDisciplina').value;
    document.getElementById('hiddenPesquisaSelecao').value = document.getElementById('inputPesquisa').value;
    
    document.getElementById('formSelecao').submit();
}

// Função para submeter filtro de disciplina
function submeterFiltroDisciplina() {
    const form = document.getElementById('filtroDisciplina');
    
    // Limpar inputs antigos de questões
    const inputsAntigos = form.querySelectorAll('input[name="questoesSelecionadas"]');
    inputsAntigos.forEach(input => input.remove());
    
    // Coletar questões selecionadas
    const checkboxes = document.querySelectorAll('input[name="questoesSelecionadas"]:checked');
    const questaoIds = Array.from(checkboxes).map(cb => cb.value);
    
    // Adicionar cada questão como um input separado
    questaoIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'questoesSelecionadas';
        input.value = id;
        form.appendChild(input);
    });
    
    // Atualizar pesquisa
    document.getElementById('hiddenPesquisa').value = document.getElementById('inputPesquisa').value;
    
    salvarEstado();
    form.submit();
}

// Função para limpar pesquisa
function limparPesquisa() {
    document.getElementById('inputPesquisa').value = '';
    salvarEstado();
    
    // Recarregar a página sem pesquisa
    const disciplinaId = document.getElementById('selectDisciplina').value;
    window.location.href = `/provas/montar?disciplinaId=${disciplinaId}`;
}

// Debug: função para limpar estado (útil para desenvolvimento)
function limparEstadoDebug() {
    localStorage.removeItem('estadoMontarProva');
    console.log('Estado limpo!');
    location.reload();
}
</script>
</body>
</html>