<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Prova</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="coordinator-layout">
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<!-- Conteúdo Principal -->
<main class="main-content">
    <div class="container-fluid">
        <!-- Cabeçalho -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="page-title">Montar Prova</h1>
                    <div class="btn-group">
                        <a th:href="@{/provas/editar-cabecalho}" class="btn btn-outline-primary">
                            <i class="material-icons">edit_note</i> Editar Cabeçalho
                        </a>
                        <a th:href="@{/provas/banco}" class="btn btn-secondary">
                            <i class="material-icons">arrow_back</i> Voltar ao Banco
                        </a>
                    </div>
                </div>
                <p class="text-muted">Adicione e organize as questões da prova</p>
            </div>
        </div>

        <!-- Layout de Dois Painéis -->
        <div class="row">
            <!-- Painel Esquerdo - Configurações -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">settings</i> Configurações da Prova
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Informações da Prova -->
                        <div class="mb-3">
                            <label class="form-label">Título da Prova</label>
                            <input type="text" class="form-control" id="tituloProva" 
                                   th:value="${tituloProvaAtual}"
                                   placeholder="Digite o título da prova">
                        </div>
                        
                        <!-- Apenas exibir curso (não editar) -->
                        <div class="mb-3">
                            <label class="form-label">Curso</label>
                            <p class="form-control-static" style="padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                <span th:each="curso : ${cursos}" 
                                      th:if="${cursoIdAtual == curso.id}"
                                      th:text="${curso.nome}">Curso</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="simulado" 
                                       th:checked="${simuladoAtual}">
                                <label class="form-check-label" for="simulado">
                                    Prova de Simulado
                                </label>
                            </div>
                        </div>

                        <!-- NOVA SEÇÃO: Disciplinas da Prova -->
						<div class="mb-4">
						    <label class="form-label fw-bold">Disciplina da Prova</label>
						
						    <!-- Formulário de adicionar disciplina (somente coordenador) -->
						    <form th:if="${(isCoordenador and isProvaCoordenador) || (disciplinasProva == null or disciplinasProva.isEmpty())}"
						          th:action="@{'/provas/editar/' + ${provaDTO.id} + '/adicionar-disciplina'}"
						          th:object="${provaDisciplinaDTO}" method="post">
						
						        <div class="input-group mb-2" style="height: 38px;">
						            <select class="form-select" th:field="*{disciplina}" style="height: 100%; font-size: 0.9rem;">
						                <option th:each="disciplina : ${disciplinas}"
						                        th:value="${disciplina.id}"
						                        th:text="${disciplina.nome}">
						                </option>
						            </select>
						
						            <button type="submit" class="btn btn-primary" style="height: 100%;">
						                <i class="material-icons" style="font-size: 18px;">add</i> Incluir
						            </button>
						        </div>
						    </form>
						
						    <!-- Lista de Disciplinas Selecionadas -->
						    <div class="mb-3">
						
						        <div th:if="${disciplinasProva != null and !disciplinasProva.isEmpty()}">
						
						            <div th:each="disciplina : ${disciplinasProva}" 
						                 class="d-flex align-items-center mb-2">
						
						                <!-- Nome da disciplina -->
						                <span class="badge bg-secondary me-2" 
						                      th:text="${disciplina.disciplina.nome}"></span>
						
						                <!-- Botão remover (sempre) -->
						                <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/remover-disciplina/' + ${disciplina.disciplina.id}}"
						                      method="post" class="m-0 p-0">
						                    <button type="submit" class="btn btn-sm btn-danger">
						                        <i class="material-icons" style="font-size: 16px;">close</i>
						                    </button>
						                </form>
						
						            </div>
						
						        </div>
						
						        <div th:if="${disciplinasProva == null or disciplinasProva.isEmpty()}">
						            <small class="text-muted">Nenhuma disciplina adicionada ainda.</small>
						        </div>
						    </div>
						
						    <!-- Texto final, apenas para coordenador -->
						    <small class="text-muted" th:if="${isCoordenador}">
						        As questões serão filtradas pelas disciplinas selecionadas
						    </small>
						</div>


                        <!-- Ações Rápidas -->
                        <div class="mb-3">
                            <label class="form-label">Ações Rápidas</label>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-info" onclick="escolherAleatorias()">
                                    <i class="material-icons">shuffle</i> Questões Aleatórias
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="embaralharQuestoes()">
                                    <i class="material-icons">swap_vert</i> Embaralhar Questões
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" onclick="salvarProva()">
                        <i class="material-icons">save</i> Salvar Prova
                    </button>
                    <button type="button" class="btn btn-primary" onclick="abrirPrevia()">
                        <i class="material-icons">visibility</i> Visualizar Prévia
                    </button>
                </div>
            </div>

            <!-- Painel Direito - Lista de Questões -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">quiz</i> Questões
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-4" id="questoesTabs">
                            <li>
                                <button class="nav-link active" id="disponiveis-tab" data-bs-toggle="tab" 
                                        data-bs-target="#disponiveis" type="button" role="tab">
                                    Questões Disponíveis
                                </button>
                            </li>
                            <li role="presentation">
                                <button class="nav-link" id="incluidas-tab" data-bs-toggle="tab" 
                                        data-bs-target="#incluidas" type="button" role="tab">
                                    Questões Incluídas na Prova
                                    <span class="badge bg-primary ms-1" id="badgeIncluidas">0</span>
                                </button>
                            </li>
                        </ul>

                        <!-- BARRA DE PESQUISA E FILTROS -->
                        <div id="abas" class="search-filter-container mb-4">
                            <div class="row g-2 align-items-center">
                                <!-- Barra de Pesquisa -->
                                <div class="col-md-8">
                                    <div class="search-input-container">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" class="d-flex w-100" id="formPesquisa">
                                            <input type="text" 
                                                   class="form-input" 
                                                   name="pesquisa" 
                                                   id="inputPesquisa"
                                                   th:value="${pesquisaAtual}"
                                                   placeholder="Pesquisar questão por enunciado, disciplina, curso ou autor..."
                                                   style="border: none; outline: none; flex: 1;">
                                            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdPesquisa">
                                            <button type="submit" class="btn btn-link p-0" style="border: none; background: none;" onclick="prepararFormPesquisa()">
                                                <span class="material-icons" style="color: #666;">search</span>
                                            </button>
                                            <button type="button" class="clear-button" onclick="limparPesquisa()">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Filtro por Disciplina -->
                                <div class="col-md-4">
                                    <div class="dropdown">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" id="filtroDisciplina">
                                            <select class="form-select" name="disciplinaId" id="selectDisciplina" onchange="submeterFiltroDisciplina()" style="font-size: 0.9rem;">
                                                <option value="0">Todas as disciplinas</option>
                                                <option th:each="disciplina : ${disciplinas}"
                                                        th:value="${disciplina.id}"
                                                        th:text="${disciplina.nome}"
                                                        th:selected="${disciplinaIdAtual != null && disciplinaIdAtual == disciplina.id}"></option>
                                            </select>
                                            <input type="hidden" name="pesquisa" id="hiddenPesquisa">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo das Abas -->
                        <div class="tab-content" id="questoesTabContent">
                            <!-- ABA 1: Questões Disponíveis -->
                            <div class="tab-pane fade show active" id="disponiveis" role="tabpanel">
                                <!-- LISTA DE QUESTÕES DISPONÍVEIS -->
								<div class="questions-list">
								    <div th:if="${questoesDisponiveis != null && !questoesDisponiveis.empty}">
								        <div class="question-item" th:each="questao : ${questoesDisponiveis}">       
								            <div class="question-content">
								                <div class="question-meta">
								                    <span class="discipline-badge" th:text="${questao.disciplina.nome}"></span><br/>
								                </div>
								
								                <!-- Enunciado -->
								                <p class="question-text fs-4" th:text="${questao.enunciado}"></p>
								
								                <!-- Imagem -->
								                <div th:if="${questao.imagem != null}" class="question-image">
								                    <span class="material-icons">image</span>
								                    <small class="text-muted">Contém imagem</small>
								                </div>

								                <!-- Alternativas -->
								                <ul class="mt-3">
								                    <li th:each="alternativa : ${questao.alternativas}"
								                        th:classappend="${alternativa.correto} ? 'fw-bold text-success' : ''">
								                        <span th:text="${alternativa.texto}"></span>
								                        <span th:if="${alternativa.correto}"
								                              class="badge bg-success ms-2">Correta</span>
								                    </li>
								                </ul>
								
								                <!-- Autor e Tipo -->
								                <div class="question-info">
								                    <small class="text-muted">
								                        <strong>Autor:</strong> 
								                        <span th:text="${questao.autor.nome}"></span> |
								
								                        <strong>Tipo:</strong> 
								                        <span th:if="${questao.simulado}">Simulado</span>
								                        <span th:unless="${questao.simulado}">Regular</span>
								                    </small>
								                </div>
								
								                <!-- BOTÃO ADICIONAR QUESTÃO -->
								                <div class="mt-3">
								                    <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/adicionar-questao'}"
								                          method="post">
								                    	<input type="hidden" name="prova.id" th:value="${provaDTO.id}">
				                						<input type="hidden" name="questao.id" th:value="${questao.id}">
								                        <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center">
								                            <i class="material-icons me-1" style="font-size: 18px;">add_circle</i>
								                            Adicionar Questão
								                        </button>
								                    </form>
								                </div>
								
								            </div>
								        </div>
								    </div>
								
								    <!-- Caso não existam questões -->
								    <div th:if="${questoesDisponiveis == null || questoesDisponiveis.empty}"
								         class="text-center py-4">
								        
								        <span class="material-icons text-muted" style="font-size: 48px;">help_outline</span>
								
								        <p class="text-muted mt-2"
								           th:if="${disciplinaSelecionada == null && termoPesquisa == null}">
								            Nenhuma questão disponível
								        </p>
								
								        <p class="text-muted mt-2"
								           th:if="${disciplinaSelecionada != null && termoPesquisa == null}">
								            Nenhuma questão encontrada para esta disciplina
								        </p>
								
								        <p class="text-muted mt-2"
								           th:if="${termoPesquisa != null}">
								            Nenhuma questão encontrada para a pesquisa: 
								            "<span th:text="${termoPesquisa}"></span>"
								        </p>	
								    </div>
								</div>
                            </div>

                            <!-- ABA 2: Questões Incluídas na Prova -->
                            <div class="tab-pane fade" id="incluidas" role="tabpanel">
                                <!-- LISTA DE QUESTÕES JÁ SELECIONADAS/INCLUÍDAS -->
                                <div class="questions-list">
								    <div th:if="${provaQuestoes != null && !provaQuestoes.empty}">
								        <div class="question-item" th:each="questao : ${provaQuestoes}">       
								            <div class="question-content">
								                <div class="question-meta">
								                    <span class="discipline-badge" th:text="${questao.questao.disciplina.nome}"></span><br/>
								                </div>
								
								                <!-- Enunciado -->
								                <p class="question-text fs-4" th:text="${questao.questao.enunciado}"></p>
								
								                <!-- Imagem -->
								                <div th:if="${questao.questao.imagem != null}" class="question-image">
								                    <span class="material-icons">image</span>
								                    <small class="text-muted">Contém imagem</small>
								                </div>

								                <!-- Alternativas -->
								                <ul class="mt-3">
								                    <li th:each="alternativa : ${questao.questao.alternativas}"
								                        th:classappend="${alternativa.correto} ? 'fw-bold text-success' : ''">
								                        <span th:text="${alternativa.texto}"></span>
								                        <span th:if="${alternativa.correto}"
								                              class="badge bg-success ms-2">Correta</span>
								                    </li>
								                </ul>
								
								                <!-- Autor e Tipo -->
								                <div class="question-info">
								                    <small class="text-muted">
								                        <strong>Autor:</strong> 
								                        <span th:text="${questao.questao.autor.nome}"></span> |
								
								                        <strong>Tipo:</strong> 
								                        <span th:if="${questao.questao.simulado}">Simulado</span>
								                        <span th:unless="${questao.questao.simulado}">Regular</span>
								                    </small>
								                </div>
								
								                <!-- BOTÃO ADICIONAR QUESTÃO -->
								                <div class="mt-3">
								                    <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/remover-questao/' + ${questao.questao.id}}"
								                          method="post">
								                        <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center">
								                            <i class="material-icons me-1" style="font-size: 18px;">remove_circle</i>
								                            Remover Questão
								                        </button>
								                    </form>
								                </div>
								
								            </div>
								        </div>
								    </div>
                                    
                                    <div th:if="${questoesSelecionadas == null || questoesSelecionadas.empty}" class="text-center py-4">
                                        <span class="material-icons text-muted" style="font-size: 48px;">remove_circle</span>
                                        <p class="text-muted mt-2">Nenhuma questão incluída na prova ainda</p>
                                        <p class="text-muted">Volte para a aba "Questões Disponíveis" para adicionar questões à prova</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
/* <![CDATA[ */
	
	// Alternar abas manualmente
document.addEventListener("DOMContentLoaded", function () {
    const tabDisponiveis = document.getElementById("disponiveis-tab");
    const tabIncluidas = document.getElementById("incluidas-tab");

    const paneDisponiveis = document.getElementById("disponiveis");
    const paneIncluidas = document.getElementById("incluidas");

    function mostrarAbaDisponiveis() {
        tabDisponiveis.classList.add("active");
        tabIncluidas.classList.remove("active");

        paneDisponiveis.classList.add("show", "active");
        paneIncluidas.classList.remove("show", "active");
    }

    function mostrarAbaIncluidas() {
        tabIncluidas.classList.add("active");
        tabDisponiveis.classList.remove("active");

        paneIncluidas.classList.add("show", "active");
        paneDisponiveis.classList.remove("show", "active");
    }

    // Eventos de clique
    tabDisponiveis.addEventListener("click", function () {
        mostrarAbaDisponiveis();
    });

    tabIncluidas.addEventListener("click", function () {
        mostrarAbaIncluidas();
    });
});


// Converte a lista Thymeleaf em um array JS e cria um Set
var inicial = /*[[${questoesSelecionadas}]]*/ [];
var questoesSelecionadasSet = new Set(Array.isArray(inicial) ? inicial.map(function(v){return parseInt(v);}) : []);

// Variável para disciplinas selecionadas (vazia inicialmente)
var disciplinasProva = new Set();

// Inicializar ao carregar DOM
document.addEventListener('DOMContentLoaded', function() {
    atualizarContadores();
    atualizarCheckboxes();
    atualizarBadgeIncluidas();
});

// Atualizar checkboxes na página conforme o Set
function atualizarCheckboxes() {
    document.querySelectorAll('.questao-checkbox').forEach(function(checkbox) {
        checkbox.checked = questoesSelecionadasSet.has(parseInt(checkbox.value));
    });
}

// Atualizar contadores (selecionadas e disciplinas)
function atualizarContadores() {
    var contadorSelecionadasEl = document.getElementById('contadorSelecionadas');
    if (contadorSelecionadasEl) contadorSelecionadasEl.textContent = questoesSelecionadasSet.size;
    atualizarBadgeIncluidas();

    var disciplinas = new Set();
    document.querySelectorAll('.questao-checkbox:checked').forEach(function(checkbox) {
        var questaoItem = checkbox.closest('.question-item');
        var disciplinaBadge = questaoItem ? questaoItem.querySelector('.discipline-badge') : null;
        if (disciplinaBadge) {
            disciplinas.add(disciplinaBadge.textContent.trim());
        }
    });
    var contadorDisciplinasEl = document.getElementById('contadorDisciplinas');
    if (contadorDisciplinasEl) contadorDisciplinasEl.textContent = disciplinas.size;
}

// Atualizar badge da aba "Incluídas"
function atualizarBadgeIncluidas() {
    var badge = document.getElementById('badgeIncluidas');
    if (badge) badge.textContent = questoesSelecionadasSet.size;
}

// Atualizar seleção individual (chamado pelo onchange dos checkboxes)
function atualizarSelecao(element) {
    var questaoId = parseInt(element.value);
    if (element.checked) {
        questoesSelecionadasSet.add(questaoId);
    } else {
        questoesSelecionadasSet.delete(questaoId);
    }
    atualizarContadores();
}

// Submeter filtro por disciplina
function submeterFiltroDisciplina() {
    var form = document.getElementById('filtroDisciplina');
    var inputPesquisa = document.getElementById('inputPesquisa');
    var hiddenPesquisa = document.getElementById('hiddenPesquisa');
    if (hiddenPesquisa && inputPesquisa) hiddenPesquisa.value = inputPesquisa.value;
    if (form) form.submit();
}

// Preparar formulário de pesquisa antes do submit
function prepararFormPesquisa() {
    var form = document.getElementById('formPesquisa');
    var hiddenDisciplina = document.getElementById('hiddenDisciplinaIdPesquisa');
    var select = document.getElementById('selectDisciplina');
    if (hiddenDisciplina && select) hiddenDisciplina.value = select.value;
    // não chamar submit aqui - deixa o submit normal do form fazer o envio
}

// Limpar pesquisa e recarregar página
function limparPesquisa() {
    var input = document.getElementById('inputPesquisa');
    if (input) input.value = '';
    var disciplinaId = document.getElementById('selectDisciplina') ? document.getElementById('selectDisciplina').value : 0;
    var provaId = /*[[${provaId}]]*/ 0;
    window.location.href = '/provas/editar-prova/' + provaId + '?disciplinaId=' + disciplinaId;
}

// Ações rápidas
function escolherAleatorias() {
    var todasQuestoes = Array.from(document.querySelectorAll('.questao-checkbox'));
    var questoesDisponiveis = todasQuestoes.filter(function(cb) { return cb.offsetParent !== null; });

    if (questoesDisponiveis.length === 0) return;

    questoesSelecionadasSet.clear();

    var embaralhadas = questoesDisponiveis.sort(function() { return Math.random() - 0.5; });
    var quantidade = Math.min(5, embaralhadas.length);

    for (var i = 0; i < quantidade; i++) {
        questoesSelecionadasSet.add(parseInt(embaralhadas[i].value));
    }

    atualizarCheckboxes();
    atualizarContadores();
}

function embaralharQuestoes() {
    alert('Funcionalidade de embaralhar questões será implementada');
}

function abrirPrevia() {
    if (questoesSelecionadasSet.size === 0) {
        alert('Selecione pelo menos uma questão para visualizar a prévia!');
        return;
    }
    var questaoIds = Array.from(questoesSelecionadasSet);
    var url = '/provas/previa?questoesSelecionadas=' + questaoIds.join(',');
    window.open(url, '_blank');
}

// Atualizar checkboxes quando a aba for mostrada (Bootstrap 5)
var questoesTabs = document.getElementById('questoesTabs');
if (questoesTabs) {
    questoesTabs.addEventListener('shown.bs.tab', function (e) {
        atualizarCheckboxes();
    });
}

/* ]]> */
</script>

</body>
</html>