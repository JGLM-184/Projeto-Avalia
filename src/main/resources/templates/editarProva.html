<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Prova</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="coordinator-layout">
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<!-- Conteúdo Principal -->
<main class="main-content">
    <div class="container-fluid">
        <!-- Cabeçalho -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="page-title">Montar Prova</h1>
                    <div class="btn-group">
                        <a th:href="@{/provas/editar-cabecalho}" class="btn btn-outline-primary">
                            <i class="material-icons">edit_note</i> Editar Cabeçalho
                        </a>
                        <a th:href="@{/provas/banco}" class="btn btn-secondary">
                            <i class="material-icons">arrow_back</i> Voltar ao Banco
                        </a>
                    </div>
                </div>
                <p class="text-muted">Adicione e organize as questões da prova</p>
            </div>
        </div>

        <!-- Layout de Dois Painéis -->
        <div class="row">
            <!-- Painel Esquerdo - Configurações -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">settings</i> Configurações da Prova
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Informações da Prova -->
                        <div class="mb-3">
                            <label class="form-label">Título da Prova</label>
                            <input type="text" class="form-control" id="tituloProva" 
                                   th:value="${tituloProvaAtual}"
                                   placeholder="Digite o título da prova">
                        </div>
                        
                        <!-- Apenas exibir curso (não editar) -->
                        <div class="mb-3">
                            <label class="form-label">Curso</label>
                            <p class="form-control-static" style="padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                <span th:each="curso : ${cursos}" 
                                      th:if="${cursoIdAtual == curso.id}"
                                      th:text="${curso.nome}">Curso</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="simulado" 
                                       th:checked="${simuladoAtual}">
                                <label class="form-check-label" for="simulado">
                                    Prova de Simulado
                                </label>
                            </div>
                        </div>

                        <!-- NOVA SEÇÃO: Disciplinas da Prova -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Disciplinas da Prova</label>
                            <div class="mb-2">
                                <small class="text-muted">Selecione as disciplinas que farão parte desta prova:</small>
                            </div>
                            
                            <!-- Lista de Disciplinas Selecionadas -->
                            <div id="disciplinasSelecionadas" class="mb-3">
                                <!-- As disciplinas serão adicionadas dinamicamente aqui -->
                            </div>

                            <!-- Selecionar Nova Disciplina - COM TAMANHO AJUSTADO -->
                            <div class="input-group mb-2" style="height: 38px;">
                                <select class="form-select" id="selectDisciplinaProva" style="height: 100%; font-size: 0.9rem;">
                                    <option value="">Selecione uma disciplina...</option>
                                    <option th:each="disciplina : ${disciplinas}"
                                            th:value="${disciplina.id}"
                                            th:text="${disciplina.nome}"></option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="adicionarDisciplina()" style="height: 100%;">
                                    <i class="material-icons" style="font-size: 18px;">add</i> Incluir
                                </button>
                            </div>
                            <small class="text-muted">As questões serão filtradas pelas disciplinas selecionadas</small>
                        </div>

                        <!-- Ações Rápidas -->
                        <div class="mb-3">
                            <label class="form-label">Ações Rápidas</label>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-info" onclick="escolherAleatorias()">
                                    <i class="material-icons">shuffle</i> Questões Aleatórias
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="embaralharQuestoes()">
                                    <i class="material-icons">swap_vert</i> Embaralhar Questões
                                </button>
                            </div>
                        </div>

                        <!-- Contadores -->
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Resumo</h6>
                                <p class="mb-1">Total de questões: <span id="totalQuestoes" th:text="${questoes.size()}">0</span></p>
                                <p class="mb-1">Selecionadas: <span id="contadorSelecionadas">0</span></p>
                                <p class="mb-0">Disciplinas: <span id="contadorDisciplinas">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" onclick="salvarProva()">
                        <i class="material-icons">save</i> Salvar Prova
                    </button>
                    <button type="button" class="btn btn-primary" onclick="abrirPrevia()">
                        <i class="material-icons">visibility</i> Visualizar Prévia
                    </button>
                </div>
            </div>

            <!-- Painel Direito - Lista de Questões -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">quiz</i> Questões
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Abas para alternar entre as listas -->
                        <ul class="nav nav-tabs mb-4" id="questoesTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="disponiveis-tab" data-bs-toggle="tab" 
                                        data-bs-target="#disponiveis" type="button" role="tab">
                                    Questões Disponíveis
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="incluidas-tab" data-bs-toggle="tab" 
                                        data-bs-target="#incluidas" type="button" role="tab">
                                    Questões Incluídas na Prova
                                    <span class="badge bg-primary ms-1" id="badgeIncluidas">0</span>
                                </button>
                            </li>
                        </ul>

                        <!-- BARRA DE PESQUISA E FILTROS -->
                        <div class="search-filter-container mb-4">
                            <div class="row g-2 align-items-center">
                                <!-- Barra de Pesquisa -->
                                <div class="col-md-8">
                                    <div class="search-input-container">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" class="d-flex w-100" id="formPesquisa">
                                            <span class="material-icons search-icon">search</span>
                                            <input type="text" 
                                                   class="form-input" 
                                                   name="pesquisa" 
                                                   id="inputPesquisa"
                                                   th:value="${pesquisaAtual}"
                                                   placeholder="Pesquisar questão por enunciado, disciplina, curso ou autor..."
                                                   style="border: none; outline: none; flex: 1;">
                                            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdPesquisa">
                                            <button type="submit" class="btn btn-link p-0" style="border: none; background: none;" onclick="prepararFormPesquisa()">
                                                <span class="material-icons" style="color: #666;">search</span>
                                            </button>
                                            <button type="button" class="clear-button" onclick="limparPesquisa()">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Filtro por Disciplina -->
                                <div class="col-md-4">
                                    <div class="dropdown">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" id="filtroDisciplina">
                                            <select class="form-select" name="disciplinaId" id="selectDisciplina" onchange="submeterFiltroDisciplina()" style="font-size: 0.9rem;">
                                                <option value="0">Todas as disciplinas</option>
                                                <option th:each="disciplina : ${disciplinas}"
                                                        th:value="${disciplina.id}"
                                                        th:text="${disciplina.nome}"
                                                        th:selected="${disciplinaIdAtual != null && disciplinaIdAtual == disciplina.id}"></option>
                                            </select>
                                            <input type="hidden" name="pesquisa" id="hiddenPesquisa">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo das Abas -->
                        <div class="tab-content" id="questoesTabContent">
                            <!-- ABA 1: Questões Disponíveis -->
                            <div class="tab-pane fade show active" id="disponiveis" role="tabpanel">
                                <!-- LISTA DE QUESTÕES DISPONÍVEIS -->
                                <div class="questions-list">
                                    <div th:if="${questoes != null && !questoes.empty}">
                                        <div class="question-item" th:each="questao : ${questoes}">
                                            <div class="question-content">
                                                <div class="question-meta">
                                                    <span class="discipline-badge" th:text="${questao.disciplina.nome}"></span>
                                                    <small class="text-muted ms-2" th:text="${questao.curso.nome}"></small>
                                                    <span th:if="${questoesSelecionadas.contains(questao.id)}" class="badge bg-success ms-2">Selecionada</span>
                                                </div>
                                                <p class="question-text" th:text="${questao.enunciado}"></p>
                                                <div th:if="${questao.imagem != null}" class="question-image">
                                                    <span class="material-icons">image</span>
                                                    <small class="text-muted">Contém imagem</small>
                                                </div>
                                                <div class="question-info">
                                                    <small class="text-muted">
                                                        <strong>Autor:</strong> <span th:text="${questao.autor.nome}"></span> |
                                                        <strong>Tipo:</strong> <span th:if="${questao.simulado}">Simulado</span><span th:unless="${questao.simulado}">Regular</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <label class="checkbox-container">
                                                <input type="checkbox" 
                                                       th:value="${questao.id}" 
                                                       class="questao-checkbox"
                                                       th:checked="${questoesSelecionadas.contains(questao.id)}"
                                                       onchange="atualizarSelecao(this)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div th:if="${questoes == null || questoes.empty}" class="text-center py-4">
                                        <span class="material-icons text-muted" style="font-size: 48px;">help_outline</span>
                                        <p class="text-muted mt-2" th:if="${disciplinaSelecionada == null && termoPesquisa == null}">Nenhuma questão disponível</p>
                                        <p class="text-muted mt-2" th:if="${disciplinaSelecionada != null && termoPesquisa == null}">Nenhuma questão encontrada para esta disciplina</p>
                                        <p class="text-muted mt-2" th:if="${termoPesquisa != null}">Nenhuma questão encontrada para a pesquisa: "<span th:text="${termoPesquisa}"></span>"</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ABA 2: Questões Incluídas na Prova -->
                            <div class="tab-pane fade" id="incluidas" role="tabpanel">
                                <!-- LISTA DE QUESTÕES JÁ SELECIONADAS/INCLUÍDAS -->
                                <div class="questions-list">
                                    <div th:if="${questoesSelecionadas != null && !questoesSelecionadas.empty}">
                                        <div class="question-item" th:each="questao : ${questoes}">
                                            <th:block th:if="${questoesSelecionadas.contains(questao.id)}">
                                                <div class="question-content">
                                                    <div class="question-meta">
                                                        <span class="discipline-badge" th:text="${questao.disciplina.nome}"></span>
                                                        <small class="text-muted ms-2" th:text="${questao.curso.nome}"></small>
                                                        <span class="badge bg-success ms-2">Incluída</span>
                                                    </div>
                                                    <p class="question-text" th:text="${questao.enunciado}"></p>
                                                    <div th:if="${questao.imagem != null}" class="question-image">
                                                        <span class="material-icons">image</span>
                                                        <small class="text-muted">Contém imagem</small>
                                                    </div>
                                                    <div class="question-info">
                                                        <small class="text-muted">
                                                            <strong>Autor:</strong> <span th:text="${questao.autor.nome}"></span> |
                                                            <strong>Tipo:</strong> <span th:if="${questao.simulado}">Simulado</span><span th:unless="${questao.simulado}">Regular</span>
                                                        </small>
                                                    </div>
                                                </div>
                                                <label class="checkbox-container">
                                                    <input type="checkbox" 
                                                           th:value="${questao.id}" 
                                                           class="questao-checkbox"
                                                           checked
                                                           onchange="atualizarSelecao(this)">
                                                    <span class="checkmark"></span>
                                                </label>
                                            </th:block>
                                        </div>
                                    </div>
                                    
                                    <div th:if="${questoesSelecionadas == null || questoesSelecionadas.empty}" class="text-center py-4">
                                        <span class="material-icons text-muted" style="font-size: 48px;">remove_circle</span>
                                        <p class="text-muted mt-2">Nenhuma questão incluída na prova ainda</p>
                                        <p class="text-muted">Volte para a aba "Questões Disponíveis" para adicionar questões à prova</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Variável global para armazenar questões selecionadas
    let questõesSelecionadas = new Set([<th:block th:each="id : ${questoesSelecionadas}">[[${id}]]<th:block th:unless="${stat.last}">, </th:block></th:block>]);

    // Variável para disciplinas selecionadas (vazia inicialmente)
    let disciplinasProva = new Set();

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        atualizarContadores();
        atualizarCheckboxes();
        atualizarBadgeIncluidas();
    });

    // Função para adicionar disciplina (APENAS DESIGN)
    function adicionarDisciplina() {
        const select = document.getElementById('selectDisciplinaProva');
        const disciplinaId = select.value;
        const disciplinaNome = select.options[select.selectedIndex].text;
        
        if (disciplinaId && !disciplinasProva.has(disciplinaId)) {
            // Adicionar visualmente à lista
            const novaDisciplina = document.createElement('div');
            novaDisciplina.className = 'd-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-light';
            novaDisciplina.innerHTML = `
                <span>${disciplinaNome}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDisciplina(this, '${disciplinaId}')">
                    <i class="material-icons" style="font-size: 16px;">remove</i>
                </button>
            `;
            document.getElementById('disciplinasSelecionadas').appendChild(novaDisciplina);
            
            // Adicionar ao Set
            disciplinasProva.add(disciplinaId);
            
            // Limpar seleção
            select.value = '';
        }
    }

    // Função para remover disciplina (APENAS DESIGN)
    function removerDisciplina(botao, disciplinaId) {
        const item = botao.closest('div');
        
        // Remover visualmente
        item.remove();
        
        // Remover do Set
        disciplinasProva.delete(disciplinaId);
    }

    // Atualizar checkboxes
    function atualizarCheckboxes() {
        document.querySelectorAll('.questao-checkbox').forEach(checkbox => {
            checkbox.checked = questõesSelecionadas.has(parseInt(checkbox.value));
        });
    }

    // Atualizar contadores
    function atualizarContadores() {
        document.getElementById('contadorSelecionadas').textContent = questõesSelecionadas.size;
        atualizarBadgeIncluidas();
        
        let disciplinas = new Set();
        document.querySelectorAll('.questao-checkbox:checked').forEach(checkbox => {
            const questaoItem = checkbox.closest('.question-item');
            const disciplinaBadge = questaoItem.querySelector('.discipline-badge');
            if (disciplinaBadge) {
                disciplinas.add(disciplinaBadge.textContent);
            }
        });
        document.getElementById('contadorDisciplinas').textContent = disciplinas.size;
    }

    // Atualizar badge da aba "Incluídas"
    function atualizarBadgeIncluidas() {
        document.getElementById('badgeIncluidas').textContent = questõesSelecionadas.size;
    }

    // Atualizar seleção individual
    function atualizarSelecao(checkbox) {
        const questaoId = parseInt(checkbox.value);
        if (checkbox.checked) {
            questõesSelecionadas.add(questaoId);
        } else {
            questõesSelecionadas.delete(questaoId);
        }
        atualizarContadores();
    }

    // Funções para a barra de pesquisa (estilo MontarProva)
    function submeterFiltroDisciplina() {
        const form = document.getElementById('filtroDisciplina');
        document.getElementById('hiddenPesquisa').value = document.getElementById('inputPesquisa').value;
        form.submit();
    }

    function prepararFormPesquisa() {
        const form = document.getElementById('formPesquisa');
        document.getElementById('hiddenDisciplinaIdPesquisa').value = document.getElementById('selectDisciplina').value;
    }

    function limparPesquisa() {
        document.getElementById('inputPesquisa').value = '';
        const disciplinaId = document.getElementById('selectDisciplina').value;
        window.location.href = `/provas/editar-prova/[[${provaId}]]?disciplinaId=${disciplinaId}`;
    }

    // Ações rápidas
    function escolherAleatorias() {
        const todasQuestoes = Array.from(document.querySelectorAll('.questao-checkbox'));
        const questoesDisponiveis = todasQuestoes.filter(cb => cb.offsetParent !== null);
        
        if (questoesDisponiveis.length === 0) return;
        
        questõesSelecionadas.clear();
        
        const embaralhadas = [...questoesDisponiveis].sort(() => Math.random() - 0.5);
        const quantidade = Math.min(5, embaralhadas.length);
        
        for (let i = 0; i < quantidade; i++) {
            const questaoId = parseInt(embaralhadas[i].value);
            questõesSelecionadas.add(questaoId);
        }
        
        atualizarCheckboxes();
        atualizarContadores();
    }

    function embaralharQuestoes() {
        alert('Funcionalidade de embaralhar questões será implementada');
    }

    function abrirPrevia() {
        if (questõesSelecionadas.size === 0) {
            alert('Selecione pelo menos uma questão para visualizar a prévia!');
            return;
        }
        
        const questaoIds = Array.from(questõesSelecionadas);
        const url = '/provas/previa?questoesSelecionadas=' + questaoIds.join(',');
        window.open(url, '_blank');
    }

    function salvarProva() {
        if (questõesSelecionadas.size === 0) {
            alert('Selecione pelo menos uma questão para salvar a prova!');
            return;
        }
        
        alert('Prova salva com sucesso!');
    }

    // Quando mudar de aba, atualizar as checkboxes
    document.getElementById('questoesTabs').addEventListener('shown.bs.tab', function (e) {
        atualizarCheckboxes();
    });
</script>
</body>
</html>