<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Prova</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="coordinator-layout">
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<!-- Conteúdo Principal -->
<main class="main-content">
    <div class="container-fluid">
        <!-- Cabeçalho -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="page-title">Montar Prova</h1>
                    <div class="btn-group">
                        <a th:href="@{/provas/editar-cabecalho}" class="btn btn-outline-primary">
                            <i class="material-icons">edit_note</i> Editar Cabeçalho
                        </a>
                        <a th:href="@{/provas/banco}" class="btn btn-secondary">
                            <i class="material-icons">arrow_back</i> Voltar ao Banco
                        </a>
                    </div>
                </div>
                <p class="text-muted">Adicione e organize as questões da prova</p>
            </div>
        </div>

        <!-- Layout de Dois Painéis -->
        <div class="row">
            <!-- Painel Esquerdo - Configurações -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">settings</i> Configurações da Prova
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Informações da Prova -->
                        <div class="mb-3">
                            <label class="form-label">Título da Prova</label>
                            <input type="text" class="form-control" id="tituloProva" 
                                   th:value="${tituloProvaAtual}"
                                   placeholder="Digite o título da prova">
                        </div>
                        
                        <!-- Apenas exibir curso (não editar) -->
                        <div class="mb-3">
                            <label class="form-label">Curso</label>
                            <p class="form-control-static" style="padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                <span th:each="curso : ${cursos}" 
                                      th:if="${cursoIdAtual == curso.id}"
                                      th:text="${curso.nome}">Curso</span>
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="simulado" 
                                       th:checked="${simuladoAtual}">
                                <label class="form-check-label" for="simulado">
                                    Prova de Simulado
                                </label>
                            </div>
                        </div>

                        <!-- NOVA SEÇÃO: Disciplinas da Prova -->
						<div class="mb-4">
						    <label class="form-label fw-bold">Disciplina da Prova</label>
						
						    <!-- Formulário de adicionar disciplina (somente coordenador) -->
						    <form th:if="${(isCoordenador and isProvaCoordenador) || (disciplinasProva == null or disciplinasProva.isEmpty())}"
						          th:action="@{'/provas/editar/' + ${provaDTO.id} + '/adicionar-disciplina'}"
						          th:object="${provaDisciplinaDTO}" method="post">
						
						        <div class="input-group mb-2" style="height: 38px;">
						            <select class="form-select" th:field="*{disciplina}" style="height: 100%; font-size: 0.9rem;">
						                <option th:each="disciplina : ${disciplinas}"
						                        th:value="${disciplina.id}"
						                        th:text="${disciplina.nome}">
						                </option>
						            </select>
						
						            <button type="submit" class="btn btn-primary" style="height: 100%;">
						                <i class="material-icons" style="font-size: 18px;">add</i> Incluir
						            </button>
						        </div>
						    </form>
						
						    <!-- Lista de Disciplinas Selecionadas -->
						    <div class="mb-3">
						
						        <div th:if="${disciplinasProva != null and !disciplinasProva.isEmpty()}">
						
						            <div th:each="disciplina : ${disciplinasProva}" 
						                 class="d-flex align-items-center mb-2">
						
						                <!-- Nome da disciplina -->
						                <span class="badge bg-secondary me-2" 
						                      th:text="${disciplina.disciplina.nome}"></span>
						
						                <!-- Botão remover (sempre) -->
						                <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/remover-disciplina/' + ${disciplina.disciplina.id}}"
						                      method="post" class="m-0 p-0">
						                    <button type="submit" class="btn btn-sm btn-danger">
						                        <i class="material-icons" style="font-size: 16px;">close</i>
						                    </button>
						                </form>
						
						            </div>
						
						        </div>
						
						        <div th:if="${disciplinasProva == null or disciplinasProva.isEmpty()}">
						            <small class="text-muted">Nenhuma disciplina adicionada ainda.</small>
						        </div>
						    </div>
						</div>

                        <!-- Geração por Questões Aleatórias -->
						<div class="mb-4">
						    <label class="form-label fw-bold">Questões Aleatórias</label>
						
						    <form th:if="${disciplinasProva != null && !disciplinasProva.isEmpty()}"
						          th:action="@{'/provas/editar/' + ${provaDTO.id} + '/gerar-aleatorias'}"
						          method="post" class="border rounded p-3 bg-light">
						
						        <p class="text-muted">Defina quantas questões deseja usar aleatoriamente de cada disciplina:</p>
						
						        <div th:each="disciplina : ${disciplinasProva}" class="mb-3">
						            <label class="form-label" th:text="${disciplina.disciplina.nome}"></label>
						            <input type="number" min="0" value="0"
						                   class="form-control"
						                   th:name="${'quantidades[' + disciplina.disciplina.id + ']'}"
						                   placeholder="Quantidade de questões dessa disciplina">
						        </div>
						
						        <button type="submit" class="btn btn-outline-info w-100">
						            <i class="material-icons">shuffle</i> Gerar Prova Aleatória
						        </button>
						    </form>
						
						    <p th:if="${disciplinasProva == null or disciplinasProva.isEmpty()}"
						       class="text-muted fst-italic">
						        Adicione disciplinas à prova para habilitar a geração automática.
						    </p>
						</div>

                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg" onclick="salvarProva()">
                        <i class="material-icons">save</i> Salvar Prova
                    </button>
                    <button type="button" class="btn btn-primary" onclick="abrirPrevia()">
                        <i class="material-icons">visibility</i> Visualizar Prévia
                    </button>
                </div>
            </div>

            <!-- Painel Direito - Lista de Questões -->
            <div id="abas" class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="material-icons">quiz</i> Questões
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-4" id="questoesTabs">
                            <li>
                                <button class="nav-link active" id="disponiveis-tab" data-bs-toggle="tab" 
                                        data-bs-target="#disponiveis" type="button" role="tab">
                                    Questões Disponíveis
                                </button>
                            </li>
                            <li role="presentation">
                                <button class="nav-link" id="incluidas-tab" data-bs-toggle="tab" 
                                        type="button" role="tab">
                                    Questões Incluídas na Prova
                                    <span class="badge bg-primary ms-1" th:text="${totalQuestoes}">0</span>
                                </button>
                            </li>
                        </ul>

                        <!-- BARRA DE PESQUISA E FILTROS -->
                        <div class="search-filter-container mb-4">
                            <div class="row g-2 align-items-center">
                                <!-- Barra de Pesquisa -->
                                <div class="col-md-8">
                                    <div class="search-input-container">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" class="d-flex w-100" id="formPesquisa">
                                            <input type="text" 
                                                   class="form-input" 
                                                   name="pesquisa" 
                                                   id="inputPesquisa"
                                                   th:value="${pesquisaAtual}"
                                                   placeholder="Pesquisar questão por enunciado, disciplina, curso ou autor..."
                                                   style="border: none; outline: none; flex: 1;">
                                            <input type="hidden" name="disciplinaId" id="hiddenDisciplinaIdPesquisa">
                                            <button type="submit" class="btn btn-link p-0" style="border: none; background: none;" onclick="prepararFormPesquisa()">
                                                <span class="material-icons" style="color: #666;">search</span>
                                            </button>
                                            <button type="button" class="clear-button" onclick="limparPesquisa()">
                                                <span class="material-icons">close</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Filtro por Disciplina -->
                                <div class="col-md-4">
                                    <div class="dropdown">
                                        <form th:action="@{/provas/editar-prova/{id}(id=${provaId})}" method="get" id="filtroDisciplina">
                                            <select class="form-select" name="disciplinaId" id="selectDisciplina" onchange="submeterFiltroDisciplina()" style="font-size: 0.9rem;">
                                                <option value="0">Todas as disciplinas</option>
                                                <option th:each="disciplina : ${disciplinas}"
                                                        th:value="${disciplina.id}"
                                                        th:text="${disciplina.nome}"
                                                        th:selected="${disciplinaIdAtual != null && disciplinaIdAtual == disciplina.id}"></option>
                                            </select>
                                            <input type="hidden" name="pesquisa" id="hiddenPesquisa">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conteúdo das Abas -->
                        <div class="tab-content" id="questoesTabContent">
                            <!-- ABA 1: Questões Disponíveis -->
                            <div class="tab-pane fade show active" id="disponiveis" role="tabpanel">
                                <!-- LISTA DE QUESTÕES DISPONÍVEIS -->
								<div class="questions-list">
								    <div th:if="${questoesDisponiveis != null && !questoesDisponiveis.empty}">
								        <div class="question-item" th:each="questao : ${questoesDisponiveis}">       
								            <div class="question-content">
								                <div class="question-meta">
								                    <span class="discipline-badge" th:text="${questao.disciplina.nome}"></span><br/>
								                </div>
								
								                <!-- Enunciado -->
								                <p class="question-text fs-4" th:text="${questao.enunciado}"></p>
								
								                <!-- Imagem -->
								                <div th:if="${questao.imagem != null}" class="question-image">
								                    <span class="material-icons">image</span>
								                    <small class="text-muted">Contém imagem</small>
								                </div>

								                <!-- Alternativas -->
								                <ul class="mt-3">
								                    <li th:each="alternativa : ${questao.alternativas}"
								                        th:classappend="${alternativa.correto} ? 'fw-bold text-success' : ''">
								                        <span th:text="${alternativa.texto}"></span>
								                        <span th:if="${alternativa.correto}"
								                              class="badge bg-success ms-2">Correta</span>
								                    </li>
								                </ul>
								
								                <!-- Autor e Tipo -->
								                <div class="question-info">
								                    <small class="text-muted">
								                        <strong>Autor:</strong> 
								                        <span th:text="${questao.autor.nome}"></span> |
								
								                        <strong>Tipo:</strong> 
								                        <span th:if="${questao.simulado}">Simulado</span>
								                        <span th:unless="${questao.simulado}">Regular</span>
								                    </small>
								                </div>
								
								                <!-- BOTÃO ADICIONAR QUESTÃO -->
								                <div class="mt-3">
								                    <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/adicionar-questao'}"
								                          method="post">
								                    	<input type="hidden" name="prova.id" th:value="${provaDTO.id}">
				                						<input type="hidden" name="questao.id" th:value="${questao.id}">
								                        <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center">
								                            <i class="material-icons me-1" style="font-size: 18px;">add_circle</i>
								                            Adicionar Questão
								                        </button>
								                    </form>
								                </div>
								
								            </div>
								        </div>
								    </div>
								
								    <!-- Caso não existam questões -->
								    <div th:if="${questoesDisponiveis == null || questoesDisponiveis.empty}"
								         class="text-center py-4">
								        
								        <span class="material-icons text-muted" style="font-size: 48px;">help_outline</span>
								
								        <p class="text-muted mt-2"
								           th:if="${disciplinaSelecionada == null && termoPesquisa == null}">
								            Nenhuma questão disponível
								        </p>
								
								        <p class="text-muted mt-2"
								           th:if="${disciplinaSelecionada != null && termoPesquisa == null}">
								            Nenhuma questão encontrada para esta disciplina
								        </p>
								
								        <p class="text-muted mt-2"
								           th:if="${termoPesquisa != null}">
								            Nenhuma questão encontrada para a pesquisa: 
								            "<span th:text="${termoPesquisa}"></span>"
								        </p>	
								    </div>
								</div>
                            </div>

                            <!-- ABA 2: Questões Incluídas na Prova -->
                            <div class="tab-pane fade" id="incluidas" role="tabpanel">
                                <!-- LISTA DE QUESTÕES JÁ SELECIONADAS/INCLUÍDAS -->
                                <div class="questions-list">
								    <div th:if="${provaQuestoes != null && !provaQuestoes.empty}">
								        <div class="question-item" th:each="questao : ${provaQuestoes}">       
								            <div class="question-content">
								                <div class="question-meta">
								                    <span class="discipline-badge" th:text="${questao.questao.disciplina.nome}"></span><br/>
								                </div>
								
								                <!-- Enunciado -->
								                <p class="question-text fs-4" th:text="${questao.questao.enunciado}"></p>
								
								                <!-- Imagem -->
								                <div th:if="${questao.questao.imagem != null}" class="question-image">
								                    <span class="material-icons">image</span>
								                    <small class="text-muted">Contém imagem</small>
								                </div>

								                <!-- Alternativas -->
								                <ul class="mt-3">
								                    <li th:each="alternativa : ${questao.questao.alternativas}"
								                        th:classappend="${alternativa.correto} ? 'fw-bold text-success' : ''">
								                        <span th:text="${alternativa.texto}"></span>
								                        <span th:if="${alternativa.correto}"
								                              class="badge bg-success ms-2">Correta</span>
								                    </li>
								                </ul>
								
								                <!-- Autor e Tipo -->
								                <div class="question-info">
								                    <small class="text-muted">
								                        <strong>Autor:</strong> 
								                        <span th:text="${questao.questao.autor.nome}"></span> |
								
								                        <strong>Tipo:</strong> 
								                        <span th:if="${questao.questao.simulado}">Simulado</span>
								                        <span th:unless="${questao.questao.simulado}">Regular</span>
								                    </small>
								                </div>
								
								                <!-- BOTÃO ADICIONAR QUESTÃO -->
								                <div class="mt-3">
								                    <form th:action="@{'/provas/editar/' + ${provaDTO.id} + '/remover-questao/' + ${questao.questao.id}}"
								                          method="post">
								                        <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center">
								                            <i class="material-icons me-1" style="font-size: 18px;">remove_circle</i>
								                            Remover Questão
								                        </button>
								                    </form>
								                </div>
								
								            </div>
								        </div>
								    </div>
                                    
                                    <div th:if="${questoesSelecionadas == null || questoesSelecionadas.empty}" class="text-center py-4">
                                        <span class="material-icons text-muted" style="font-size: 48px;">remove_circle</span>
                                        <p class="text-muted mt-2">Nenhuma questão incluída na prova ainda</p>
                                        <p class="text-muted">Volte para a aba "Questões Disponíveis" para adicionar questões à prova</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
	// Alternar abas manualmente
	document.addEventListener("DOMContentLoaded", function () {
    const tabDisponiveis = document.getElementById("disponiveis-tab");
    const tabIncluidas = document.getElementById("incluidas-tab");

    const paneDisponiveis = document.getElementById("disponiveis");
    const paneIncluidas = document.getElementById("incluidas");

    function mostrarAbaDisponiveis() {
        tabDisponiveis.classList.add("active");
        tabIncluidas.classList.remove("active");

        paneDisponiveis.classList.add("show", "active");
        paneIncluidas.classList.remove("show", "active");
    }

    function mostrarAbaIncluidas() {
        tabIncluidas.classList.add("active");
        tabDisponiveis.classList.remove("active");

        paneIncluidas.classList.add("show", "active");
        paneDisponiveis.classList.remove("show", "active");
    }
    
 	// --- Selecionar aba inicial com base no parâmetro da URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const aba = urlParams.get("aba");

    if (aba === "incluidas") {
        mostrarAbaIncluidas();
    } else {
        // padrão: aba de disponíveis
        mostrarAbaDisponiveis();
    }

    // Eventos de clique
    tabDisponiveis.addEventListener("click", function () {
        mostrarAbaDisponiveis();
    });

    tabIncluidas.addEventListener("click", function () {
        mostrarAbaIncluidas();
    });
});
</script>

</body>
</html>