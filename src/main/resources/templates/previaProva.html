<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prévia da Prova</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="icon" type="image/png" href="/imagens/logo.png">

</head>
<body class="coordinator-layout">

    <div th:replace="~{navbar :: navbar}"></div>

    <main class="main-content">
        <div class="container-fluid">

            <div class="row mb-3 no-print">
                <div class="col-12">
                    <a th:href="@{'/provas/editar/' + ${provaId}}" class="btn btn-outline-secondary">
                        <span class="material-icons">arrow_back</span>
                        Voltar
                    </a>
                </div>
            </div>

            <div class="pdf-preview" id="pdfPreview">

                <!-- CABEÇALHO EM TABELA -->
				
				<table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
				    <tr>
				        <td style="font-weight: bold; font-size: 14px;">CENTRO PAULA SOUZA</td>
				        <td style="font-weight: bold; font-size: 14px; text-align: right;">FACULDADE DE TECNOLOGIA DE GUARULHOS</td>
				    </tr>
				</table>
				
                <table class="header-table">
                    <tr><td colspan="2" style="height:8px;"></td></tr>

                    <tr>
                        <td><strong>Professor:</strong></td>
                        <td th:text="${professor.nome}"></td>
                    </tr>

                    <tr>
                        <td><strong>Disciplina(s):</strong></td>
                        <td>
                            <span th:each="disciplina : ${disciplinas}" th:text="${disciplina.nome + ' '}"></span>
                        </td>
                    </tr>

                    <tr>
                        <td><strong>Aluno:</strong></td>
                        <td>____________________________________</td>
                    </tr>

                    <tr>
                        <td><strong>Data:</strong></td>
                        <td>_____/______/__________</td>
                    </tr>
                </table>
				
				<table>
					<tr>
						<td colspan="2" style="font-size:30px; font-weight:bold;" th:text="${titulo}">TÍTULO</td>
					</tr>
				</table>

				<!-- GABARITO ESTILO ENEM (COLUNA ÚNICA) -->
				<div class="pdf-answer-sheet">
				    <table class="gabarito-enem-table">
				        <tbody>
				            <tr th:each="questao, iter : ${questoes}">
				                <td class="num-questao" th:text="${iter.count}"></td>
				                <td class="alt">A</td>
				                <td class="alt">B</td>
				                <td class="alt">C</td>
				                <td class="alt">D</td>
				                <td class="alt">E</td>
				            </tr>
				        </tbody>
				    </table>
				</div>
				
				<div class="page-break"></div>

                <!-- QUESTÕES -->
                <div class="pdf-questions">

                    <div th:if="${#lists.isEmpty(questoes)}" class="text-center py-4 text-muted">
                        Nenhuma questão foi adicionada à prova.
                    </div>

                    <div th:each="questao, iter : ${questoes}" class="pdf-question">

                        <div>
                            <span class="pdf-question-number" th:text="${iter.count} + ') '"></span>
                            <span class="pdf-question-text" th:utext="${questao.questao.enunciado}"></span>
                        </div>

                        <div th:if="${questao.questao.imagem != null}" class="pdf-question-image">
                            <img th:src="${questao.questao.imagem}" style="max-width: 600px;">
                        </div>

                        <div class="pdf-alternatives" th:if="${questao.questao.alternativas != null}">
                            <div th:each="alternativa, iterAlt : ${questao.questao.alternativas}" class="pdf-alternative">
                                <div class="pdf-alternative-letter"
                                     th:text="'( ' + ${'ABCDE'.substring(iterAlt.count - 1, iterAlt.count)} + ' )'">
                                </div>
                                <div class="pdf-alternative-text" th:utext="${alternativa.texto}"></div>
                            </div>
                        </div>

                    </div>

                </div>

            </div>

        </div>

        <div class="preview-actions no-print">
            <button class="btn btn-normal no-print" data-bs-toggle="modal" data-bs-target="#modalGabarito">
                Gabarito
            </button>

            <button class="btn btn-normal me-2" id="btnImprimirProva">
                <span class="material-icons" style="font-size:16px;">print</span>
                Imprimir
            </button>


            <a th:href="@{'/provas/detalhes/' + ${provaId} + '?embaralhar=true'}" 
               class="btn btn-cancel">
                <span class="material-icons" style="font-size:16px;">shuffle</span>
                Embaralhar
            </a>
        </div>
    </main>

    <!-- MODAL DO GABARITO -->
    <div class="modal fade" id="modalGabarito" tabindex="-1" aria-labelledby="modalGabaritoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="modalGabaritoLabel">Gabarito da Prova</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body" id="contentGabarito">

                    <table class="table table-bordered text-center">
                        <thead>
                            <tr>
                                <th>Questão</th>
                                <th>Resposta</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="questao, iter : ${questoes}">
                                <td th:text="${iter.count}"></td>
                                <td>
                                    <span th:each="alt, iterAlt : ${questao.questao.alternativas}"
                                          th:if="${alt.isCorreto()}">
                                        <span th:text="${iterAlt.count == 1 ? 'A' : 
                                                         iterAlt.count == 2 ? 'B' : 
                                                         iterAlt.count == 3 ? 'C' :
                                                         iterAlt.count == 4 ? 'D' : 'E'}"></span>
                                    </span>
                                </td>
                            </tr>
                        </tbody>

                    </table>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>

                    <button class="btn btn-primary" id="btnImprimirGabarito">
                        <span class="material-icons" style="font-size:16px;">print</span>
                        Imprimir Gabarito
                    </button>

                </div>

            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
	
    <script>
        document.getElementById("btnImprimirProva").addEventListener("click", () => {
            imprimirProva();
        });

        function imprimirProva() {
            window.scrollTo(0, 0);
            document.body.classList.add("modo-impressao");

            setTimeout(() => {
                window.print();
                document.body.classList.remove("modo-impressao");
            }, 200);
        }
    </script>

    <script>
        document.getElementById("btnImprimirGabarito").addEventListener("click", () => {
            imprimirGabarito();
        });

        function imprimirGabarito() {

            const conteudo = document.getElementById("contentGabarito").innerHTML;

            const janela = window.open("", "_blank", "width=800,height=600");
            janela.document.write(`
                <html>
                <head>
                    <title>Gabarito</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                </head>
                <body>
                    <div class="container mt-4">
                        <h3 class="text-center mb-3">Gabarito</h3>
                        ${conteudo}
                    </div>
                </body>
                </html>
            `);

            janela.document.close();

            setTimeout(() => {
                janela.print();
            }, 300);
        }
    </script>

</body>
</html>
