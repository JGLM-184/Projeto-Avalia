<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Cursos</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="coordinator-layout">
<div th:replace="~{navbar :: navbar}"></div>

<div class="container py-5">
    <h1 class="text-center mb-4">Gerenciar Cursos</h1>

    <!-- ================= FORMULÁRIO ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Cadastrar Novo Curso</h5>

            <form th:action="@{'/cursos/salvar'}" method="post">
                <div class="mb-3">
                    <label for="nome" class="form-label">Nome do Curso</label>
                    <input type="text" id="nome" name="nome" class="form-control" placeholder="Digite o nome do curso" required>
                </div>
                <button type="submit" class="btn btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <!-- ================= LISTA ================= -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Lista de Cursos</h5>

            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th class="text-center" style="width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="curso : ${cursos}">
                        <td th:text="${curso.id}"></td>
                        <td th:text="${curso.nome}"></td>
                        <td class="text-center">

                            <!-- BOTÃO EDITAR QUE ABRE O MODAL -->
                            <button 
                                class="btn btn-sm btn-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#modalEditar"
                                th:attr="data-id=${curso.id}, data-nome=${curso.nome}">
                                Editar
                            </button>

                            <!-- BOTÃO EXCLUIR: vamos interceptar e abrir o modal de confirmação -->
                            <a th:href="@{'/cursos/excluir/' + ${curso.id}}"
                               class="btn btn-sm btn-danger ms-1 delete-btn"
                               th:attr="data-id=${curso.id}, data-nome=${curso.nome}">
                               Excluir
                            </a>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(cursos)}">
                        <td colspan="3" class="text-center text-muted">Nenhum curso cadastrado.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-center mt-4">
        <a th:href="@{/teste}" class="btn btn-outline-secondary">Voltar à Página de Testes</a>
    </div>
</div>

<!-- ==================== MODAL DE EDIÇÃO ==================== -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="formEditar" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Curso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label class="form-label">Nome do Curso</label>
                    <input type="text" id="editarNome" name="nome" class="form-control" required>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ==================== MODAL DE CONFIRMAÇÃO DE EXCLUSÃO ==================== -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar Exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este curso?
        <div class="mt-2 text-muted small" id="cursoToDeleteInfo"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDeleteBtn" class="btn btn-danger">Excluir</a>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL DE MENSAGEM (ERRO / SUCESSO) ==================== -->
<div class="modal fade" id="messageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p id="messageText"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
/* Script: preenche o modal de edição quando clicar em Editar */
document.addEventListener("click", function(e) {
    if (e.target.matches("[data-bs-target='#modalEditar']")) {
        let id = e.target.getAttribute("data-id");
        let nome = e.target.getAttribute("data-nome");

        document.getElementById("editarNome").value = nome;
        document.getElementById("formEditar").action = "/cursos/atualizar/" + id;
    }
});

/* Script: intercepta botões de excluir e abre modal de confirmação */
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const link = this.getAttribute('href');
    const nome = this.getAttribute('data-nome');
    document.getElementById('confirmDeleteBtn').setAttribute('href', link);
    document.getElementById('cursoToDeleteInfo').innerText = "Curso: " + nome;
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
  });
});

/* Script: mostra modal de mensagem baseado em mensagens enviadas pelo controller */
window.addEventListener("DOMContentLoaded", () => {
    const error = /*[[${errorMessage}]]*/ null;
    const success = /*[[${successMessage}]]*/ null;

    if (error !== null && error !== "") {
        document.getElementById("messageText").innerText = error;
        new bootstrap.Modal(document.getElementById("messageModal")).show();
    } 
    else if (success !== null && success !== "") {
        document.getElementById("messageText").innerText = success;
        new bootstrap.Modal(document.getElementById("messageModal")).show();
    }
});
</script>

</body>
</html>
