<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gerenciar Usuário</title>

	<link rel="stylesheet" th:href="@{/css/style.css}">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	
	<link rel="icon" type="image/png" href="/imagens/logo.png">
</head>

<body class="coordinator-layout">
<div th:replace="~{navbar :: navbar}"></div>

<main class="main-content">
	<div class="card wide-form">

		<form class="user-form"
		      th:action="${idProfessor != null} ? @{'/users/editar/' + ${idProfessor}} : @{/users/cadastrar}"
			  method="post"
			  th:object="${professor}">

			<h2 th:text="${idProfessor != null} ? 'Editar Usuário' : 'Criar Novo Usuário'"></h2>
			
			<!-- MENSAGENS DE ERRO / SUCESSO -->
			<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
			    <p th:text="${errorMessage}"></p>
			</div>

			<div th:if="${successMessage}" class="alert alert-success" role="alert">
			    <p th:text="${successMessage}"></p>
			</div>


			<div class="form-group">
				<input type="text" th:field="*{nome}" class="form-input" placeholder=" " required>
				<label>Nome</label>
			</div>

			<div class="form-group">
				<input type="email" th:field="*{email}" class="form-input" placeholder=" " required>
				<label>Email</label>
			</div>

			<div class="form-group">
				<input type="text" th:field="*{re}" class="form-input" placeholder=" " required>
				<label>RE</label>
			</div>

			<!-- Senha só aparece se for cadastro -->
			<div class="form-group" th:if="${idProfessor == null}">
			    <input type="password" th:field="*{senha}" class="form-input" placeholder=" " required>
			    <label>Senha</label>
			</div>

			<div class="custom-checkbox">
				<input type="checkbox" th:field="*{coordenador}">
				<label>Coordenador</label>
			</div>

			<div class="custom-checkbox">
				<input type="checkbox" th:field="*{ativo}">
				<label>Ativo</label>
			</div>

			<hr class="my-4">

			<h4>Cursos</h4>

			<div id="formAddCurso" class="row g-3 align-items-end">
			    <div class="col-md-6">
			        <label class="form-label">Selecione um Curso</label>
			        <select id="cursoSelect" class="form-select">
						<option th:each="curso : ${listaCursos}"
						        th:value="${curso.id}"
						        th:text="${curso.nome}">
						</option>
			        </select>
			    </div>

			    <div class="col-md-3 align-items-end">
			        <button type="button" id="btnAddCurso" class="btn btn-geren">
						<span class="material-icons">add</span>
					</button>
			    </div>
			</div>

			<ul id="listaCursos" class="list-group mt-3"></ul>
			<input type="hidden" name="idsCursos" id="cursosIds">

			<hr class="my-4">

			<div id="disciplinasContainer">
				<h4>Disciplinas</h4>
	
				<div id="formAddDisciplina" class="row g-3 align-items-end">
				    <div class="col-md-6">
				        <label class="form-label">Selecione uma Disciplina</label>
				        <select id="disciplinaSelect" class="form-select">
				            <!-- preenchido dinamicamente -->
				        </select>
				    </div>
	
				    <div class="col-md-3">
				        <button type="button" id="btnAddDisciplina" class="btn btn-geren">
							<span class="material-icons">add</span>
						</button>
				    </div>
				</div>
	
				<ul id="listaDisciplinas" class="list-group mt-3"></ul>
				<input type="hidden" name="idsDisciplinas" id="disciplinasIds">
			</div>

			<div class="form-actions" style="margin-top: 1rem;">
			    <a th:href="@{/users/painel}" class="btn btn-secondary">Cancelar</a>
			    <button type="submit" class="btn btn-geren"
			            th:text="${idProfessor != null} ? 'Salvar Alterações' : 'Criar Usuário'"></button>
			</div>

		</form>

	</div>
</main>

<script th:inline="javascript">
    var idProfessor   = /*[[${idProfessor}]]*/ null;
    var professor = {
        idsCursos: /*[[${professor.idsCursos}]]*/ [],
        idsDisciplinas: /*[[${professor.idsDisciplinas}]]*/ []
    };
    
    var todasDisciplinas = /*[[${listaDisciplinas}]]*/ []
</script>

<script>
let cursosSelecionados = [];
let disciplinasSelecionadas = [];

// Função para atualizar a lista de cursos na UI
function atualizarCursosUI() {
    const ul = document.getElementById("listaCursos");
    ul.innerHTML = "";
    cursosSelecionados.forEach(id => {
        const nome = document.querySelector(`#cursoSelect option[value="${id}"]`)?.text || "";
        ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">
            ${nome}
            <button class="btn btn-sm btn-danger" type="button" onclick="removerCurso('${id}')">Remover</button>
        </li>`;
    });
    document.getElementById("cursosIds").value = cursosSelecionados.join(",");
}

// Função para remover um curso
function removerCurso(id) {
    // Remove o curso da lista
    cursosSelecionados = cursosSelecionados.filter(x => x !== id);

    // Remover disciplinas associadas a esse curso
    const disciplinasDoCurso = todasDisciplinas
        .filter(d => String(d.curso.id) === String(id))
        .map(d => String(d.id));

    disciplinasSelecionadas = disciplinasSelecionadas.filter(
        dId => !disciplinasDoCurso.includes(String(dId))
    );

    atualizarCursosUI();
    atualizarDisciplinasUI();
    carregarDisciplinas();
}

// Função para atualizar a lista de disciplinas na UI
function atualizarDisciplinasUI() {
    const ul = document.getElementById("listaDisciplinas");
    if (!ul) return;
    
    ul.innerHTML = "";

    disciplinasSelecionadas.forEach(id => {
        const disc = todasDisciplinas.find(d => String(d.id) === String(id));
        const nome = disc ? disc.nome : "(nome não encontrado)";

        ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">
            ${nome}
            <button class="btn btn-sm btn-danger" type="button" onclick="removerDisciplina('${id}')">Remover</button>
        </li>`;
    });

    document.getElementById("disciplinasIds").value = disciplinasSelecionadas.join(",");
}


// Função para remover uma disciplina
function removerDisciplina(id) {
    disciplinasSelecionadas = disciplinasSelecionadas.filter(x => x !== id);
    atualizarDisciplinasUI();
}

// Função para carregar disciplinas dinamicamente a partir dos cursos selecionados
function carregarDisciplinas() {
    const select = document.getElementById("disciplinaSelect");
    if (!select) return;
    if (cursosSelecionados.length === 0) {
        select.innerHTML = "";
        return;
    }

    fetch(`/disciplinas/por-cursos?cursosIds=${cursosSelecionados.join(",")}`)
        .then(response => response.json())
        .then(data => {
            select.innerHTML = "";
            if (data.length === 0) {
                select.innerHTML = `<option value="">Nenhuma disciplina disponível</option>`;
                return;
            }
            data.forEach(d => {
                if (!disciplinasSelecionadas.includes(String(d.id))) {
                    select.innerHTML += `<option value="${d.id}">${d.nome}</option>`;
                }
            });
        })
        .catch(err => console.error("Erro ao carregar disciplinas:", err));
}

// Botão adicionar curso
document.getElementById("btnAddCurso").addEventListener("click", function() {
    const select = document.getElementById("cursoSelect");
    const id = select.value;
    if (!cursosSelecionados.includes(id)) {
        cursosSelecionados.push(id);
        atualizarCursosUI();
        carregarDisciplinas();
    }
});

// Botão adicionar disciplina
try {
	document.getElementById("btnAddDisciplina").addEventListener("click", function() {
	    const select = document.getElementById("disciplinaSelect");
	    const id = select.value;
	    if (!disciplinasSelecionadas.includes(id)) {
	        disciplinasSelecionadas.push(id);
	        atualizarDisciplinasUI();
	    }
	});
} catch { }

// Função para inicializar a edição (preenche listas com os valores do professor)
function inicializarEdicao() {
    // Carrega cursos do DTO do backend
    if (typeof professor !== "undefined" && professor.idsCursos) {
        cursosSelecionados = professor.idsCursos.map(String);
        atualizarCursosUI();
    }

    // Carrega disciplinas do DTO do backend
    if (typeof professor !== "undefined" && professor.idsDisciplinas) {
        disciplinasSelecionadas = professor.idsDisciplinas.map(String);
        atualizarDisciplinasUI();
    }

    // Após carregar cursos, atualizar disciplinas disponíveis no select
    carregarDisciplinas();
}

// Se for edição, inicializa automaticamente
if (typeof idProfessor !== "undefined" && idProfessor != null) {
    inicializarEdicao();
}

//Ativa/Desativa incluir disciplinas ao desmarcar/marcar checkbox de coordenador
function atualizarVisibilidadeDisciplinas() {
    const checkbox = document.querySelector('input[name="coordenador"]');
    const container = document.getElementById("disciplinasContainer");

    if (!checkbox || !container) return;

    if (checkbox.checked) {
        // OCULTA O BLOCO
        container.style.display = "none";

        // REMOVE TODAS AS DISCIPLINAS
        disciplinasSelecionadas = [];
        atualizarDisciplinasUI();

        // Também limpa o select dinamicamente
        const select = document.getElementById("disciplinaSelect");
        if (select) select.innerHTML = "";
    } else {
        // MOSTRA O BLOCO
        container.style.display = "block";

        // Recarrega as disciplinas disponíveis conforme os cursos selecionados
        carregarDisciplinas();
    }
}


document.querySelector('input[name="coordenador"]').addEventListener("change", atualizarVisibilidadeDisciplinas);
document.addEventListener("DOMContentLoaded", atualizarVisibilidadeDisciplinas);

</script>



</body>
</html>
