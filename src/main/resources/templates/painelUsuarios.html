<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	  <title>Painel de Usuários</title>
	  <link rel="stylesheet" th:href="@{/css/style.css}">
	  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	
	<link rel="icon" type="image/png" href="/imagens/logo.png">
</head>

<body class="coordinator-layout">
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<main class="main-content">
<div class="user-section container">

    <!-- Botão Novo Usuário -->
	<div class="mb-2">
	    <a th:href="@{'/users/cadastrar'}" class="btn btn-adicionar-usuario">
	        <span class="material-icons" style="font-size:16px;">person_add</span> Novo Usuário
	    </a>
	</div>
	
  <!-- Card com tabela de usuários -->
  <div class="card-usuario shadow-sm">
        <div class="card-body">
        <h5 class="card-title">Usuários Cadastrados</h5>
        
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-cabecalho">
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>RA</th>
                        <th>Coordenador</th>
						<th>Cursos</th>
                        <th>Disciplinas</th>
                        <th>Ativo</th>
                        <th>1°Acesso</th>
                        <th>Controles</th>
                    </tr>
                </thead>
				<tbody>
				<tr th:each="professor : ${professores}">
				    <td th:text="${professor.nome}"></td>
				    <td th:text="${professor.email}" class="texto-reticencia"></td>
				    <td th:text="${professor.re}"></td>
					
					<td>
						<span class="usuarios-badge-status"
							th:classappend="${professor.coordenador} ? ' status-sim' : ' status-nao'">
							<span th:text="${professor.coordenador} ? 'Sim' : 'Não'"></span>
						</span>
					</td>
					
					<td class="quebraTexto" th:utext="${professor.nomesCursosFormatado}"></td>
					<td class="quebraTexto" th:utext="${professor.nomesDisciplinasFormatado}"></td>

					<td>
					    <span class="usuarios-badge-status" 
					          th:classappend="${professor.ativo} ? ' status-sim' : ' status-nao'">
					        <span th:text="${professor.ativo} ? 'Sim' : 'Não'"></span>
					    </span>
					</td>
					
					<td>
						<span class="usuarios-badge-status"
							th:classappend="${professor.primeiroAcesso} ? ' status-sim' : ' status-nao'">
							<span th:text="${professor.primeiroAcesso} ? 'Sim' : 'Não'"></span>
						</span>
					</td>

					
				    <td>
						<!--Botão de editar-->
				        <a th:href="@{'/users/editar/' + ${professor.id}}" class="btn action-btn" style="background: rgb(224, 221, 255); margin-bottom: 0.5rem; margin-left: 1rem">
				            <span class="material-icons" style="font-size:16px;">edit</span> 
				        </a>
						
						<!--Botão de excluir-->
						<a th:if="${professor.id != usuarioLogado.id}"
						   th:href="@{'/users/excluir/' + ${professor.id}}" 
						   class="btn action-btn delete-btn" style="background: rgb(247, 202, 202); margin-left: 1rem">
						    <span class="material-icons" style="font-size:16px;">delete</span> 
						</a>

						<!-- Se for o usuário logado, só mostra desabilitado -->
						<button th:if="${professor.id == usuarioLogado.id}"
						        class="btn action-btn" style="background: #ccc; margin-left: 1rem" disabled>
						    <span class="material-icons" style="font-size:16px;">block</span> 
						</button>
						<!-- Botão Alterar Senha -->
						<button 
								class="btn action-btn alterar-senha-btn" 
								style="background: rgb(221, 240, 255); margin-left: 1rem"
								th:data-id-professor="${professor.id}">
							<span class="material-icons" style="font-size:16px;">lock</span>
						</button>
					</td>

				</tr>
				</tbody>
            </table>
        </div>
        
    </div>
  </div>
  
  <div class="text-center mt-4">
      <a th:href="@{'/coordenador/painel'}" class="btn btn-outline-secondary">Voltar ao painel</a>
  </div>
</div>
</main>

<!-- Modal de confirmação de exclusão -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar Exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este usuário?
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDeleteBtn" class="btn btn-danger">Excluir</a>
      </div>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const link = this.getAttribute('href');
    document.getElementById('confirmDeleteBtn').setAttribute('href', link);
    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
  });
});
</script>


<!-- Modal de mensagem -->
<div class="modal fade" id="messageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p id="messageText"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
    window.addEventListener("DOMContentLoaded", () => {
        /* Pegando mensagens de erro e sucesso (se existirem) */
        const error = /*[[${errorMessage}]]*/ null;
        const success = /*[[${successMessage}]]*/ null;

        if (error !== null && error !== "") {
            document.getElementById("messageText").innerText = error;
            new bootstrap.Modal(document.getElementById("messageModal")).show();
        } 
        else if (success !== null && success !== "") {
            document.getElementById("messageText").innerText = success;
            new bootstrap.Modal(document.getElementById("messageModal")).show();
        }
    });
</script>


<script>
document.querySelectorAll('.alterar-senha-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.getAttribute("data-id-professor");
        document.getElementById("idProfessorTrocaSenha").value = id;

        new bootstrap.Modal(document.getElementById('modalTrocaSenha')).show();
    });
});
</script>



<!-- Modal Troça de Senha -->
<div class="modal fade" id="modalTrocaSenha" tabindex="-1" aria-labelledby="trocaSenhaLabel" aria-hidden="true"> 
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="trocaSenhaLabel">Troca de senha</h5>
      </div>

      <div class="modal-body">
        <p>Alterar senha do usuário selecionado.</p>

        <form id="formTrocaSenhaModal" th:action="@{/coordenador/alterar-senha}" method="post">

          <!-- ID do professor (preenchido via JS) -->
          <input type="hidden" id="idProfessorTrocaSenha" name="idProfessor">

          <div class="mb-3">
            <label for="novaSenhaModal" class="label-popup">Nova senha</label>
            <input type="password" class="form-control" id="novaSenhaModal" name="novaSenha" required>
          </div>

          <div class="mb-3">
            <label for="confirmarSenhaModal" class="label-popup">Confirmar senha</label>
            <input type="password" class="form-control" id="confirmarSenhaModal" name="confirmarSenha" required>
          </div>

          <!-- Mensagem de erro -->
          <div th:if="${erro}" class="text-danger mb-2" id="erroSenhaModal" th:text="${erro}"></div>

          <!-- Botões -->
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>

            <button type="submit" class="btn btn-primary">
              Salvar nova senha
            </button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>


</body>
</html>
